<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordini Pranzo di Gruppo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        /* Stile per la scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px;}
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px;}
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .paid-order {
            opacity: 0.6;
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Contenitore Principale -->
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 text-center">Ordini Pranzo di Gruppo ü•™</h1>
            <p class="text-center text-gray-600 mt-2">Organizza il pranzo con i tuoi colleghi in modo semplice e veloce.</p>
            <p class="text-center text-red-600 font-bold mt-2">Attenzione: L'ordine e il pagamento devono essere completati entro le 11:30.</p>
        </header>

        <!-- Navigazione -->
        <nav class="flex justify-center bg-white p-2 rounded-xl shadow-md mb-6 sticky top-4 z-10">
            <button data-view="menu" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold transition-all duration-300">
                <i class="fas fa-utensils mr-2"></i>Men√π
            </button>
            <button data-view="my-order" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold transition-all duration-300">
                <i class="fas fa-shopping-basket mr-2"></i>Il Mio Ordine <span id="cart-count" class="bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 inline-flex items-center justify-center ml-1">0</span>
            </button>
            <button data-view="all-orders" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold transition-all duration-300">
                <i class="fas fa-users mr-2"></i>Tutti gli Ordini
            </button>
        </nav>

        <main>
            <!-- Vista Men√π -->
            <div id="menu-view" class="view">
                <h2 id="menu-title" class="text-2xl font-bold mb-4">Scegli cosa ordinare</h2>
                
                <!-- Filtri Categoria -->
                <div id="category-filters" class="flex items-center justify-center flex-wrap gap-2 mb-4">
                    <!-- I pulsanti di filtro categoria verranno inseriti qui da JS -->
                </div>

                <!-- Filtri Regime Alimentare -->
                <div id="diet-filters" class="flex items-center justify-center flex-wrap gap-2 mb-6 bg-white p-2 rounded-xl shadow-md">
                    <!-- I pulsanti di filtro verranno inseriti qui da JS -->
                </div>

                <div id="menu-items" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Le card del men√π verranno inserite qui da JS -->
                </div>

                <!-- Legenda Allergeni -->
                <div id="allergen-legend" class="mt-8 bg-white p-4 rounded-xl shadow-md">
                    <!-- La legenda verr√† inserita qui da JS -->
                </div>
            </div>

            <!-- Vista Il Mio Ordine -->
            <div id="my-order-view" class="view">
                <h2 class="text-2xl font-bold mb-4">Riepilogo del Tuo Ordine</h2>
                <div id="my-order-content" class="bg-white p-6 rounded-xl shadow-md">
                    <!-- Il contenuto del mio ordine verr√† inserito qui -->
                </div>
            </div>

            <!-- Vista Tutti gli Ordini -->
            <div id="all-orders-view" class="view">
                 <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-bold">Riepilogo Ordini di Oggi</h2>
                    <button id="copy-summary-btn" class="w-full md:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <i class="fas fa-copy mr-2"></i> Copia Riepilogo per Ristoratore
                    </button>
                </div>

                <!-- Sezione Istruzioni Pagamento -->
                <div id="payment-instructions" class="mb-6 bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-lg hidden">
                    <!-- Istruzioni di pagamento verranno inserite qui -->
                </div>

                <div id="all-orders-list" class="space-y-4">
                    <!-- La lista di tutti gli ordini verr√† inserita qui -->
                </div>
                 <div class="mt-6 bg-white p-4 rounded-xl shadow-lg text-right">
                    <span class="text-xl font-bold text-gray-800">Totale Complessivo di Oggi:</span>
                    <span id="grand-total" class="text-2xl font-bold text-blue-600 ml-2">‚Ç¨0.00</span>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal per inserimento nome utente -->
    <div id="user-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-md text-center">
            <h3 class="text-2xl font-bold mb-4">Benvenuto!</h3>
            <p class="text-gray-600 mb-6">Per iniziare, inserisci il tuo nome. Verr√† mostrato agli altri nel riepilogo. <br><b class="text-red-600">Importante:</b> Usa lo stesso nome che utilizzerai per il pagamento su Satispay.</p>
            <input type="text" id="username-input" placeholder="Es. Marco Rossi" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            <button id="save-username-btn" class="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">Salva e Continua</button>
        </div>
    </div>

    <!-- Modal per QR Code Satispay -->
    <div id="qr-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-md text-center relative">
            <button id="close-qr-modal-btn" class="absolute top-2 right-4 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            <h3 class="text-2xl font-bold mb-4">Paga con Satispay</h3>
            <p class="text-gray-600 mb-4">Inquadra questo QR code con la tua app Satispay per pagare il tuo ordine.</p>
            <img id="qr-code-image" src="" alt="QR Code Satispay" class="mx-auto rounded-lg shadow-md w-full max-w-xs">
            <div class="mt-4 text-sm text-gray-600">
                <p>Non hai Satispay? <a href="https://www.satispay.com/it-it/privati/" target="_blank" class="text-blue-600 hover:underline">Scarica l'app</a> e ricevi un bonus di 5‚Ç¨ con il codice <span class="font-bold">WEB</span>.</p>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-3 px-6 rounded-full shadow-xl transition-all duration-300 opacity-0 z-50">
        <p id="toast-message"></p>
    </div>


    <!-- Firebase -->
    <script type="module">
        // Importa le funzioni necessarie da Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, serverTimestamp, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCQJsNbgaR89gF_1vLe6H4DPboOhQvm9nI",
            authDomain: "app-ordini-pranzo-alimentari.firebaseapp.com",
            projectId: "app-ordini-pranzo-alimentari",
            storageBucket: "app-ordini-pranzo-alimentari.firebasestorage.app",
            messagingSenderId: "553169964686",
            appId: "1:553169964686:web:7f8ca6f32a301949e4c3df",
            measurementId: "G-KVM4C29KZ1"
        };

        // Inizializzazione di Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Riferimenti alle collezioni
        const ordersCollectionRef = collection(db, `orders`);

        // --- DATI E STATO DELL'APPLICAZIONE ---
        
        const QR_CODE_IMAGE_URL = "https://i.imgur.com/KCFwG0O.jpeg"; 

        const MERCHANT_INFO = {
            name: "Alimentari Russo",
            paymentMethod: "Satispay"
        };

        const PRICES = { gastronomia: 4.00, verdure: 4.00, panini: 3.50, pizze: 3.50, fritti: 1.50, dessert: 3.00 };
        const ALLERGENS = { G: { name: "Glutine", icon: "üåæ" }, L: { name: "Latticini", icon: "ü•õ" }, C: { name: "Crostacei", icon: "ü¶ê" }, P: { name: "Pesce", icon: "üêü" }};
        const DIETS = { vegetariano: { name: "Vegetariano", icon: "üßÄ" }, vegano: { name: "Vegano", icon: "üå±" }, pescetariano: { name: "Pescetariano", icon: "üêü" } };
        const RAW_MENU = {
            gastronomia: [
                { name: "Cous cous vegetale con pollo", allergens: ["G"], diet: ["onnivoro"], calories: 450 },
                { name: "Cous cous vegetale", allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 350 },
                { name: "Farro vegetale", allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 380 },
                { name: "Farro vegetale con salmone", allergens: ["G", "P"], diet: ["pescetariano"], calories: 480 },
                { name: "Riso Venere con gamberi e zucchine", allergens: ["C"], diet: ["pescetariano"], calories: 420 },
                { name: "Insalata di riso", allergens: [], diet: ["onnivoro"], calories: 400 },
                { name: "Pasta fredda con tonno pomodori e olive", allergens: ["G", "P"], diet: ["pescetariano"], calories: 450 },
                { name: "Pasta fredda pesto primo sale pomodori olive", allergens: ["G", "L"], diet: ["vegetariano"], calories: 500 },
                { name: "Insalata di pollo", allergens: [], diet: ["onnivoro"], calories: 350 },
                { name: "Riso integrale bresaola limone e rughetta", allergens: [], diet: ["onnivoro"], calories: 380 },
                { name: "Pomodori con riso e patate (a peso)", allergens: [], diet: ["vegetariano", "vegano"], calories: 300 }
            ],
            dessert: [
                 { name: "Macedonia", allergens: [], diet: ["vegetariano", "vegano"], calories: 120 }
            ],
            fritti: [
                { name: "Suppl√¨", allergens: ["G", "L"], diet: ["vegetariano"], calories: 250 },
                { name: "Polpetta di melanzane", allergens: ["G", "L"], diet: ["vegetariano"], calories: 180 }
            ],
            verdure: [
                { name: "Melanzane (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 180 },
                { name: "Zucchine (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 160 },
                { name: "Peperoni (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 160 },
                { name: "Cicoria (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 140 },
                { name: "Broccoletti (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 150 },
                { name: "Broccoli (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 150 },
                { name: "Scarola con olive (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 130 }
            ],
            panini: [
                { name: "Crudo pomodoro mozzarella", allergens: ["G", "L"], diet: ["onnivoro"], calories: 550 },
                { name: "Crudo stracchino rughetta", allergens: ["G", "L"], diet: ["onnivoro"], calories: 580 },
                { name: "Cotto arrosto scamorza e verdura", allergens: ["G", "L"], diet: ["onnivoro"], calories: 520 },
                { name: "Capocollo pecorino e pomodori secchi", allergens: ["G", "L"], diet: ["onnivoro"], calories: 600 },
                { name: "Salame pecorino e pomodori secchi", allergens: ["G", "L"], diet: ["onnivoro"], calories: 620 },
                { name: "Speck Brie e pomodori secchi", allergens: ["G", "L"], diet: ["onnivoro"], calories: 610 },
                { name: "Porchetta", allergens: ["G"], diet: ["onnivoro"], calories: 650 },
                { name: "Vegetariano melanzane zucchine e peperoni", allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 450 },
                { name: "Pane 5 cereali con tacchino e verdura", allergens: ["G"], diet: ["onnivoro"], calories: 480 },
                { name: "Pane integrale bresaola parmigiano e rughetta", allergens: ["G", "L"], diet: ["onnivoro"], calories: 500 },
                { name: "Pane arabo bresaola primo sale e rughetta", allergens: ["G", "L"], diet: ["onnivoro"], calories: 470 },
                { name: "Pane ai cereali con salmone e formaggio", allergens: ["G", "L", "P"], diet: ["pescetariano"], calories: 530 },
                { name: "Tonno e pomodoro", allergens: ["G", "P"], diet: ["pescetariano"], calories: 490 },
                { name: "Tonno e carciofini", allergens: ["G", "P"], diet: ["pescetariano"], calories: 510 }
            ],
            pizze: [
                { name: "Crudo e mozzarella", allergens: ["G", "L"], diet: ["onnivoro"], calories: 600 },
                { name: "Speck stracchino e rughetta", allergens: ["G", "L"], diet: ["onnivoro"], calories: 650 },
                { name: "Cotto arrosto e melanzane", allergens: ["G", "L"], diet: ["onnivoro"], calories: 580 },
                { name: "Mortadella e stracciatella", allergens: ["G", "L"], diet: ["onnivoro"], calories: 700 },
                { name: "Frittata e zucchine", allergens: ["G", "L"], diet: ["vegetariano"], calories: 550 },
                { name: "Pizza 5 cereali bresaola e formaggio", allergens: ["G", "L"], diet: ["onnivoro"], calories: 580 },
                { name: "Pizza 5 cereali con insalata di pollo", allergens: ["G"], diet: ["onnivoro"], calories: 560 },
                { name: "Focaccia ‚Äúgenovese‚Äù cotto e stracchino", allergens: ["G", "L"], diet: ["onnivoro"], calories: 620 }
            ]
        };

        function processMenuData(rawMenu, prices) {
            let idCounter = 1;
            const categoryIcons = { gastronomia: 'fa-bowl-food', fritti: 'fa-stroopwafel', verdure: 'fa-carrot', panini: 'fa-bread-slice', pizze: 'fa-pizza-slice', dessert: 'fa-ice-cream' };
            return Object.entries(rawMenu).flatMap(([category, items]) => 
                items.map(item => ({
                    id: idCounter++,
                    name: item.name,
                    category: category.charAt(0).toUpperCase() + category.slice(1),
                    price: prices[category] || 0,
                    icon: categoryIcons[category] || 'fa-utensils',
                    diet: item.diet,
                    allergens: item.allergens,
                    calories: item.calories
                }))
            );
        }

        const state = {
            currentUser: null,
            currentView: 'menu',
            activeCategoryFilter: 'all',
            activeDietFilter: 'all',
            cart: [],
            selectingAlternativeFor: null, 
            allOrders: [],
            menuData: processMenuData(RAW_MENU, PRICES)
        };

        // --- ELEMENTI DEL DOM ---
        const views = document.querySelectorAll('.view');
        const navBtns = document.querySelectorAll('.nav-btn');
        const menuTitle = document.getElementById('menu-title');
        const menuItemsContainer = document.getElementById('menu-items');
        const categoryFiltersContainer = document.getElementById('category-filters');
        const dietFiltersContainer = document.getElementById('diet-filters');
        const allergenLegendContainer = document.getElementById('allergen-legend');
        const cartCountEl = document.getElementById('cart-count');
        const myOrderContentEl = document.getElementById('my-order-content');
        const allOrdersListEl = document.getElementById('all-orders-list');
        const grandTotalEl = document.getElementById('grand-total');
        const copySummaryBtn = document.getElementById('copy-summary-btn');
        const userModal = document.getElementById('user-modal');
        const usernameInput = document.getElementById('username-input');
        const saveUsernameBtn = document.getElementById('save-username-btn');
        const paymentInstructions = document.getElementById('payment-instructions');
        const qrModal = document.getElementById('qr-modal');
        const qrCodeImage = document.getElementById('qr-code-image');
        const toastEl = document.getElementById('toast');
        const toastMessageEl = document.getElementById('toast-message');

        // --- FUNZIONI DI UTILITY ---
        function showToast(message, duration = 3000) {
            toastMessageEl.textContent = message;
            toastEl.classList.remove('opacity-0');
            setTimeout(() => { toastEl.classList.add('opacity-0'); }, duration);
        }

        function navigate(viewName) {
            state.currentView = viewName;
            views.forEach(view => view.classList.toggle('active', view.id === `${viewName}-view`));
            navBtns.forEach(btn => {
                btn.classList.toggle('bg-blue-500', btn.dataset.view === viewName);
                btn.classList.toggle('text-white', btn.dataset.view === viewName);
            });
            window.scrollTo(0, 0);
        }

        function formatTimestamp(timestamp) {
            if (!timestamp || !timestamp.toDate) return '';
            const date = timestamp.toDate();
            return date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
        }
        
        const isOrderTimeBlocked = () => {
            const now = new Date();
            return now.getHours() > 11 || (now.getHours() === 11 && now.getMinutes() >= 30);
        };

        // --- FUNZIONI DI RENDER ---
        function renderFilters() {
            // Render filtri categoria
            let categoryFiltersHtml = `<button data-category="all" class="category-filter-btn py-2 px-4 rounded-full font-semibold transition-all duration-300 ${state.activeCategoryFilter === 'all' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'}">Tutte</button>`;
            Object.keys(RAW_MENU).forEach(category => {
                const categoryName = category.charAt(0).toUpperCase() + category.slice(1);
                categoryFiltersHtml += `<button data-category="${category}" class="category-filter-btn py-2 px-4 rounded-full font-semibold transition-all duration-300 ${state.activeCategoryFilter === category ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'}">${categoryName}</button>`;
            });
            categoryFiltersContainer.innerHTML = categoryFiltersHtml;

            // Render filtri dieta
            let dietFiltersHtml = `<button data-diet="all" class="diet-filter-btn flex items-center gap-2 py-2 px-4 rounded-lg font-semibold transition-all duration-300 ${state.activeDietFilter === 'all' ? 'bg-blue-500 text-white' : 'bg-gray-200'}">üçΩÔ∏è<span>Tutti</span></button>`;
            Object.entries(DIETS).forEach(([key, dietInfo]) => {
                dietFiltersHtml += `<button data-diet="${key}" class="diet-filter-btn flex items-center gap-2 py-2 px-4 rounded-lg font-semibold transition-all duration-300 ${state.activeDietFilter === key ? 'bg-blue-500 text-white' : 'bg-gray-200'}"><span>${dietInfo.icon}</span><span>${dietInfo.name}</span></button>`;
            });
            dietFiltersContainer.innerHTML = dietFiltersHtml;

            // Render legenda
            let legendHtml = '<p class="font-bold mb-2">Legenda Allergeni:</p><div class="flex flex-wrap gap-x-4 gap-y-2">';
            Object.values(ALLERGENS).forEach(info => { legendHtml += `<span class="flex items-center text-sm">${info.icon} ${info.name}</span>`; });
            legendHtml += '</div>';
            allergenLegendContainer.innerHTML = legendHtml;
        }

        function renderMenu() {
            const isSelectingAlternative = state.selectingAlternativeFor !== null;
            menuTitle.textContent = isSelectingAlternative ? "Scegli un'alternativa" : "Scegli cosa ordinare";

            const filteredItems = state.menuData.filter(item => {
                const categoryMatch = state.activeCategoryFilter === 'all' || item.category.toLowerCase() === state.activeCategoryFilter;
                const dietMatch = state.activeDietFilter === 'all' || item.diet.includes(state.activeDietFilter) || item.diet.includes('onnivoro');
                return categoryMatch && dietMatch;
            });

            if (filteredItems.length === 0) {
                menuItemsContainer.innerHTML = `<div class="col-span-full text-center p-8 bg-white rounded-xl shadow-md"><p class="text-gray-500">Nessun piatto trovato con i filtri selezionati. Prova a cambiare la tua ricerca!</p></div>`;
                return;
            }

            menuItemsContainer.innerHTML = filteredItems.map(item => {
                const allergenHtml = item.allergens.map(key => `<span title="${ALLERGENS[key].name}">${ALLERGENS[key].icon}</span>`).join('');
                
                const buttonHtml = isSelectingAlternative
                    ? `<button data-id="${item.id}" class="select-as-alternative-btn w-full mt-4 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                       <i class="fas fa-check"></i> Seleziona
                    </button>`
                    : `<button data-id="${item.id}" class="add-to-cart-btn w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                       <i class="fas fa-plus"></i> Aggiungi
                    </button>`;

                return `
                <div class="bg-white p-4 rounded-xl shadow-md hover:shadow-lg transition-shadow flex flex-col">
                    <div class="flex-grow">
                        <div class="flex items-center mb-2">
                             <i class="fas ${item.icon} text-blue-500 text-xl mr-3 w-6 text-center"></i>
                             <h3 class="font-bold text-lg">${item.name}</h3>
                        </div>
                        <p class="text-gray-600 ml-9">${item.category}</p>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <div class="flex gap-3 text-lg">${allergenHtml}</div>
                        <span class="font-semibold text-lg">‚Ç¨${item.price.toFixed(2)}</span>
                    </div>
                    <p class="text-xs text-gray-500 text-right mt-1">~${item.calories} kcal (stima)</p>
                    ${buttonHtml}
                </div>`;
            }).join('');
        }
        
        function renderPaymentInstructions() {
            if (state.allOrders.length > 0) {
                paymentInstructions.innerHTML = `
                    <p class="font-bold">Come pagare:</p>
                    <p>1. Paga la tua quota direttamente a <span class="font-semibold">${MERCHANT_INFO.name}</span>.</p>
                    <button id="show-qr-btn" class="mt-2 bg-red-500 text-white font-bold py-2 px-4 rounded-lg inline-flex items-center"><svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M7.657 20.837c.18.332.473.58.81.718.337.138.71.157.953.157h.034c.414 0 .81-.13 1.125-.39 1.38-1.146 2.003-3.118 2.003-5.634 0-2.035-.525-4.12-1.93-5.26-.334-.278-.737-.417-1.17-.417-.282 0-.68.084-.954.168-.31.093-.586.27-.783.503-.197.234-.302.51-.302.813 0 .225.084.504.253.837.168.333.39.63.664.88.31.28.663.505.953.665.29.16.485.242.485.242.06 0 .09.006.104.01.015.004.02.013.02.013.094.037.164.23.164.48 0 .42-.23.75-.653.93-.424.18-.954.15-1.59-.09-.636-.24-1.11-0.67-1.38-1.28-.11-.25-.26-.59-.44-.99-.18-.4-.41-.8-.69-1.19-.28-.39-.6-.75-1.01-1.07-1.29-1.02-3.15-1.5-5.2-1.5H3.143L3 18.11h3.32c.39 0 .75-.12.98-.37.23-.25.34-.56.34-.92 0-.36-.11-.67-.34-.92-.23-.25-.59-.37-.98-.37H3.81l.16-1.04h2.5c1.6 0 2.9.37 3.9 1.11.28.2.53.43.75.69.22.26.4.55.54.87.14.32.23.68.23 1.07 0 .39-.09.75-.27 1.08-.18.33-.44.63-.78.89-.34.26-.75.49-1.22.68-.47.19-.98.32-1.53.38zM21 8.267c-1.3-.23-2.3-.9-3-2.01-.7-1.11-1-2.4-1-3.85 0-.11-.03-.2-.09-.27-.06-.07-.15-.1-.25-.1H12.9c-.39 0-.75.12-.98.37-.23.25-.34-.56-.34-.92 0 .36.11.67.34.92.23.25.59.37.98.37h3.04c.48 0 .87.13 1.19.4.32.27.53.62.65 1.04.12.42.12.87.01 1.34-.11.47-.32.9-.62 1.28-.3.38-.68.7-1.13.95-.45.25-.96.43-1.53.54-.57.11-1.16.16-1.77.16h-.4l-.25 1.6h.65c.61 0 1.2-.05 1.77-.16.57-.11 1.1-.29 1.57-.54s.89-.57 1.22-.95c.33-.38.59-.82.78-1.32.19-.5.28-1.03.28-1.59 0-.22-.02-.43-.06-.63z"></path></svg> Paga con Satispay</button>
                    <p>2. Dopo aver pagato, <span class="font-bold">spunta la casella "Pagato"</span> accanto al tuo nome.</p>
                    <p class="text-sm mt-2 text-red-700"><b>Importante:</b> Assicurati di effettuare il pagamento Satispay usando lo stesso nome che hai inserito nell'app per permettere al ristoratore di associare l'ordine.</p>
                    <p class="text-sm mt-2 text-red-700">Ricorda: solo gli ordini pagati entro le 11:30 verranno inviati!</p>
                `;
                paymentInstructions.classList.remove('hidden');
            } else {
                paymentInstructions.classList.add('hidden');
            }
        }

        function renderMyOrder() {
            cartCountEl.textContent = state.cart.length;
            if (!state.currentUser || !state.currentUser.name) {
                myOrderContentEl.innerHTML = `<p class="text-center text-gray-500">Inserisci il tuo nome per creare un ordine.</p>`;
                return;
            }
            const userOrder = state.allOrders.find(order => order.userId === state.currentUser.uid);
            if (userOrder) {
                let itemsHtml = userOrder.items.map(item => `<div class="flex justify-between items-center py-2 border-b"><span>${item.name} (x${item.quantity})</span><span class="font-semibold">‚Ç¨${(item.price * item.quantity).toFixed(2)}</span></div>`).join('');
                myOrderContentEl.innerHTML = `<p class="text-lg font-semibold mb-2">Ciao ${state.currentUser.name}, questo √® il tuo ordine confermato:</p><div class="space-y-2 mb-4">${itemsHtml}</div><div class="text-right font-bold text-xl my-4">Totale: ‚Ç¨${userOrder.total.toFixed(2)}</div><button id="delete-my-order-btn" data-id="${userOrder.id}" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors"><i class="fas fa-trash-alt mr-2"></i> Cancella il mio ordine</button>`;
            } else if (state.cart.length > 0) {
                let itemsHtml = state.cart.map(item => `
                    <div class="py-2 border-b">
                        <div class="flex justify-between items-center">
                            <span>${item.name}</span>
                            <div class="flex items-center gap-2">
                                <span class="font-semibold">‚Ç¨${item.price.toFixed(2)}</span>
                                <button data-cart-item-id="${item.cartItemId}" class="remove-from-cart-btn text-red-500 hover:text-red-700 text-sm"><i class="fas fa-times-circle"></i></button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <p class="text-xs text-gray-500">Alternativa: <span class="font-semibold">${item.alternativeChoice || 'Nessuna'}</span></p>
                            <button data-cart-item-id="${item.cartItemId}" class="select-alternative-btn text-xs text-blue-600 hover:underline mt-1">${item.alternativeChoice ? 'Modifica' : 'Scegli'} alternativa</button>
                        </div>
                    </div>
                `).join('');

                const total = state.cart.reduce((sum, item) => sum + item.price, 0);
                const totalCalories = state.cart.reduce((sum, item) => sum + (item.calories || 0), 0);
                const orderBlocked = isOrderTimeBlocked();

                myOrderContentEl.innerHTML = `
                    <div class="space-y-2 mb-4">${itemsHtml}</div>
                    <textarea id="order-notes" class="w-full p-2 border rounded-lg mt-4" placeholder="Note generali per la preparazione (es. senza cipolla)"></textarea>
                    <div class="mt-4">
                        <p class="font-semibold mb-2">Metodo di Pagamento:</p>
                        <div class="flex gap-4">
                            <label class="flex items-center"><input type="radio" name="paymentMethod" value="Satispay" class="mr-2" checked> Satispay</label>
                            <label class="flex items-center"><input type="radio" name="paymentMethod" value="Contanti/Carta alla consegna" class="mr-2"> Contanti/Carta alla consegna</label>
                        </div>
                    </div>
                    <div class="text-right font-bold text-xl my-4">
                        <span>Totale: ‚Ç¨${total.toFixed(2)}</span>
                        <span class="text-sm font-normal text-gray-500">(~${totalCalories} kcal)</span>
                    </div>
                    <button id="confirm-order-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-colors ${orderBlocked ? 'opacity-50 cursor-not-allowed' : ''}" ${orderBlocked ? 'disabled' : ''}>
                        <i class="fas fa-check-circle mr-2"></i> Conferma Ordine
                    </button>
                    ${orderBlocked 
                        ? `<p class="text-xs text-red-600 text-center mt-2">Le ordinazioni sono chiuse dopo le 11:30.</p>`
                        : `<p class="text-xs text-gray-500 text-center mt-2">Cliccando, il tuo ordine verr√† aggiunto alla lista condivisa e non sar√† pi√π modificabile.</p>`
                    }
                `;
            } else {
                myOrderContentEl.innerHTML = `<p class="text-center text-gray-500 py-8">Il tuo carrello √® vuoto. Aggiungi qualcosa dal men√π!</p>`;
            }
        }

        function renderAllOrders() {
            renderPaymentInstructions();
            if (state.allOrders.length === 0) {
                allOrdersListEl.innerHTML = `<div class="text-center bg-white p-8 rounded-xl shadow"><p class="text-gray-500">Nessun ordine per oggi. Sii il primo!</p></div>`;
                grandTotalEl.textContent = '‚Ç¨0.00';
                return;
            }

            allOrdersListEl.innerHTML = '';
            let grandTotal = 0;
            state.allOrders.forEach(order => {
                grandTotal += order.total;
                const isMyOrder = state.currentUser.uid === order.userId;
                const orderCard = document.createElement('div');
                orderCard.className = `bg-white p-4 rounded-xl shadow-md transition-opacity duration-300 ${order.paid ? 'paid-order' : ''}`;
                let itemsHtml = order.items.map(item => `
                    <li>
                        ${item.quantity}x ${item.name}
                        ${item.alternativeChoice ? `<span class="text-xs text-gray-500 block ml-4">‚Ü≥ Alt: ${item.alternativeChoice}</span>` : ''}
                    </li>`).join('');
                
                orderCard.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-lg flex items-center">${order.userName} 
                            <span class="ml-2 text-xs font-semibold py-0.5 px-2 rounded-full ${order.paymentMethod === 'Satispay' ? 'bg-blue-200 text-blue-800' : 'bg-green-200 text-green-800'}">${order.paymentMethod}</span>
                        </p>
                        <ul class="list-disc list-inside text-gray-700 mt-2">${itemsHtml}</ul>
                        ${order.notes ? `<p class="text-sm text-gray-500 mt-2"><em>Note: ${order.notes}</em></p>` : ''}
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-lg">‚Ç¨${order.total.toFixed(2)}</p>
                        <p class="text-xs text-gray-400 mt-1"><i class="far fa-clock"></i> ${formatTimestamp(order.createdAt)}</p>
                        ${isMyOrder ? `<button data-id="${order.id}" class="delete-my-order-btn text-red-500 hover:text-red-700 text-xs mt-2">Cancella</button>` : ''}
                    </div>
                </div>
                <div class="border-t mt-3 pt-3 flex justify-end items-center">
                    <label class="flex items-center ${isMyOrder ? 'cursor-pointer' : 'cursor-not-allowed'}">
                        <input type="checkbox" data-order-id="${order.id}" class="paid-checkbox h-5 w-5 rounded text-blue-600 focus:ring-blue-500 border-gray-300" ${order.paid ? 'checked' : ''} ${!isMyOrder ? 'disabled' : ''}>
                        <span class="ml-2 text-sm font-medium ${order.paid ? 'text-green-600' : 'text-gray-600'}">${order.paid ? 'Pagato' : 'Da pagare'}</span>
                        ${order.paid ? '<i class="fas fa-check-circle text-green-600 ml-2"></i>' : ''}
                    </label>
                </div>`;
                allOrdersListEl.appendChild(orderCard);
            });
            grandTotalEl.textContent = `‚Ç¨${grandTotal.toFixed(2)}`;
        }
        
        // --- GESTIONE DEGLI EVENTI ---
        function handleEvents(e) {
            const buttonTarget = e.target.closest('button');
            if (buttonTarget) handleClicks(buttonTarget);
            
            const checkboxTarget = e.target.closest('input[type="checkbox"].paid-checkbox');
            if(checkboxTarget) handlePaymentStatusChange(checkboxTarget);
        }

        function handleClicks(target) {
            if (target.matches('.category-filter-btn')) {
                document.querySelectorAll('.category-filter-btn').forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                target.classList.add('bg-indigo-600', 'text-white');
                target.classList.remove('bg-gray-200', 'text-gray-700');
                state.activeCategoryFilter = target.dataset.category;
                renderMenu();
            }
            else if (target.matches('.diet-filter-btn')) {
                document.querySelectorAll('.diet-filter-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('bg-gray-200');
                });
                target.classList.add('bg-blue-500', 'text-white');
                target.classList.remove('bg-gray-200');
                state.activeDietFilter = target.dataset.diet;
                renderMenu();
            }
            else if (target.matches('.nav-btn')) { navigate(target.dataset.view); }
            else if (target.matches('.add-to-cart-btn')) {
                const itemId = parseInt(target.dataset.id);
                const item = state.menuData.find(i => i.id === itemId);
                if (item) {
                    state.cart.push({ ...item, cartItemId: crypto.randomUUID(), alternativeChoice: '' });
                    renderMyOrder();
                    cartCountEl.textContent = state.cart.length;
                    showToast(`${item.name} aggiunto al carrello!`);
                }
            }
            else if (target.matches('.select-as-alternative-btn')) {
                const itemId = parseInt(target.dataset.id);
                const item = state.menuData.find(i => i.id === itemId);
                const cartItem = state.cart.find(ci => ci.cartItemId === state.selectingAlternativeFor);
                if (item && cartItem) {
                    cartItem.alternativeChoice = item.name;
                    state.selectingAlternativeFor = null;
                    renderMenu();
                    navigate('my-order');
                    renderMyOrder();
                }
            }
            else if (target.matches('.select-alternative-btn')) {
                state.selectingAlternativeFor = target.dataset.cartItemId;
                navigate('menu');
                renderMenu();
            }
            else if (target.matches('.remove-from-cart-btn')) {
                const cartItemId = target.dataset.cartItemId;
                const itemIndex = state.cart.findIndex(i => i.cartItemId === cartItemId);
                if(itemIndex > -1){
                    const removedItem = state.cart.splice(itemIndex, 1)[0];
                    renderMyOrder();
                    showToast(`${removedItem.name} rimosso.`);
                }
            }
            else if (target.id === 'confirm-order-btn') { handleConfirmOrder(); }
            else if (target.matches('.delete-my-order-btn') || target.id === 'delete-my-order-btn') { handleDeleteOrder(target.dataset.id); }
            else if (target.id === 'save-username-btn') {
                const username = usernameInput.value.trim();
                if (username) {
                    localStorage.setItem('lunch-order-username', username);
                    state.currentUser.name = username;
                    userModal.classList.add('hidden');
                    renderMyOrder();
                } else { showToast('Per favore, inserisci un nome.', 2000); }
            }
            else if (target.id === 'copy-summary-btn') { handleCopySummary(); }
            else if (target.id === 'show-qr-btn') {
                qrCodeImage.src = QR_CODE_IMAGE_URL;
                qrModal.classList.remove('hidden');
            }
            else if (target.id === 'close-qr-modal-btn') {
                qrModal.classList.add('hidden');
            }
        }
        
        // --- LOGICA DI BUSINESS E FIRESTORE ---
        async function handlePaymentStatusChange(checkbox) {
            const orderId = checkbox.dataset.orderId;
            const isPaid = checkbox.checked;
            const orderDocRef = doc(db, `orders`, orderId);
            try {
                await updateDoc(orderDocRef, { paid: isPaid });
                showToast(`Stato pagamento aggiornato!`, 2000);
            } catch (error) {
                console.error("Errore nell'aggiornamento dello stato di pagamento:", error);
                showToast("Errore nell'aggiornamento.", 3000);
                checkbox.checked = !isPaid; // Revert on error
            }
        }

        async function handleConfirmOrder() {
            if (state.cart.length === 0) { showToast("Il carrello √® vuoto!", 2000); return; }
            
            const groupedCart = state.cart.reduce((acc, item) => {
                if (!acc[item.id]) {
                    acc[item.id] = { ...item, quantity: 0 };
                }
                acc[item.id].quantity++;
                // L'alternativa √® legata al tipo di prodotto, non alla singola istanza
                if (item.alternativeChoice) {
                    acc[item.id].alternativeChoice = item.alternativeChoice;
                }
                return acc;
            }, {});

            const orderItems = Object.values(groupedCart);
            const total = orderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const notes = document.getElementById('order-notes').value.trim();
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

            const orderData = { userId: state.currentUser.uid, userName: state.currentUser.name, items: orderItems, total: total, notes: notes, createdAt: serverTimestamp(), paid: false, paymentMethod: paymentMethod };
            
            try {
                await setDoc(doc(ordersCollectionRef, state.currentUser.uid), orderData);
                state.cart = [];
                showToast("Ordine confermato con successo!", 2000);
                renderMyOrder();
                navigate('all-orders');
            } catch (error) {
                console.error("Errore dettagliato nella conferma dell'ordine: ", error);
                showToast(`Errore: ${error.message}`, 4000);
            }
        }
        
        async function handleDeleteOrder(orderId) {
            try {
                await deleteDoc(doc(ordersCollectionRef, orderId));
                showToast("Ordine cancellato.", 2000);
            } catch (error) {
                console.error("Errore nella cancellazione dell'ordine: ", error);
                showToast("Errore durante la cancellazione.", 3000);
            }
        }

        function handleCopySummary() {
            const paidOrders = state.allOrders.filter(order => order.paid && order.paymentMethod === 'Satispay');
            const cashOrders = state.allOrders.filter(order => order.paymentMethod === 'Contanti/Carta alla consegna');

            if (paidOrders.length === 0 && cashOrders.length === 0) {
                showToast("Nessun ordine da inviare.", 3000);
                return;
            }

            let summaryText = `Ciao! Vorremmo effettuare il seguente ordine per il pranzo di oggi da DOS Design.\n\n`;

            if (paidOrders.length > 0) {
                summaryText += `--- PAGATI CON SATISPAY ---\n`;
                paidOrders.forEach(order => {
                    summaryText += `*${order.userName}*:\n`;
                    order.items.forEach(item => {
                        summaryText += `- ${item.quantity}x ${item.name}\n`;
                        if (item.alternativeChoice) {
                            summaryText += `  _(Alt: ${item.alternativeChoice})_\n`;
                        }
                    });
                    if (order.notes) { summaryText += `  _(Note: ${order.notes})_\n`; }
                    summaryText += `\n`;
                });
            }

            if (cashOrders.length > 0) {
                summaryText += `--- DA PAGARE IN CONTANTI/CARTA ALLA CONSEGNA ---\n`;
                cashOrders.forEach(order => {
                    summaryText += `*${order.userName}*:\n`;
                    order.items.forEach(item => {
                        summaryText += `- ${item.quantity}x ${item.name}\n`;
                        if (item.alternativeChoice) {
                            summaryText += `  _(Alt: ${item.alternativeChoice})_\n`;
                        }
                    });
                    if (order.notes) { summaryText += `  _(Note: ${order.notes})_\n`; }
                    summaryText += `\n`;
                });
            }

            summaryText += `====================\n`;
            summaryText += `*TOTALE COMPLESSIVO: ‚Ç¨${state.allOrders.reduce((sum, order) => sum + order.total, 0).toFixed(2)}*\n\n`;
            summaryText += `L'indirizzo di consegna √® *Via Arno, 52*.\n\n`;
            summaryText += `Per favore, potete confermarci la preparazione e indicarci un orario di consegna previsto? Grazie!`;
            
            const textarea = document.createElement('textarea');
            textarea.value = summaryText;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast("Messaggio per WhatsApp copiato!", 3000);
        }

        // --- INIZIALIZZAZIONE ---
        async function deleteAllOrders() {
            // Rimosso il confirm() che causa problemi in alcuni ambienti
            console.log("Inizio cancellazione di tutti gli ordini...");
            try {
                const querySnapshot = await getDocs(ordersCollectionRef);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
                showToast("Tutti gli ordini sono stati cancellati.", 3000);
            } catch (error) {
                console.error("Errore durante la cancellazione degli ordini:", error);
                showToast("Errore durante la cancellazione.", 3000);
            }
        }
        window.deleteAllOrders = deleteAllOrders;


        function setupAppForUser(user) {
            state.currentUser = { uid: user.uid };
            
            onSnapshot(ordersCollectionRef, async (snapshot) => {
                const allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);

                state.allOrders = allOrders.filter(order => order.createdAt && order.createdAt.toDate() >= todayStart);
                
                renderAllOrders();
                renderMyOrder();
            });

            const savedName = localStorage.getItem('lunch-order-username');
            if (savedName && savedName.trim() !== '') {
                state.currentUser.name = savedName;
            } else {
                userModal.classList.remove('hidden');
            }
        }

        async function init() {
            document.body.addEventListener('click', handleEvents);
            document.body.addEventListener('change', handleEvents);

            renderFilters();
            renderMenu();
            navigate('menu');

            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user && !state.currentUser) { 
                        setupAppForUser(user); 
                    }
                });
            } catch (error) {
                console.error("Errore di autenticazione:", error);
                showToast("Errore di autenticazione. Controlla le regole di sicurezza e la configurazione di Firebase.", 5000);
            }
        }

        init();
    </script>
</body>
</html>
