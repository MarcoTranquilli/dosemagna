<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dosemagna</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px;}
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px;}
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .paid-order { opacity: 0.6; transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 text-center">dosemagna ü•™</h1>
            <p class="text-center text-gray-600 mt-2 italic">‚ÄúIl pranzo di quartiere, genuino e a portata di click.‚Äù</p>
            <p class="text-center text-red-600 font-bold mt-4">Attenzione: L'ordine e il pagamento devono essere completati entro le 11:30.</p>
        </header>

        <nav class="flex justify-center bg-white p-2 rounded-xl shadow-md mb-6 sticky top-4 z-10">
            <button data-view="menu" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold transition-all duration-300"><i class="fas fa-utensils mr-2"></i>Men√π</button>
            <button data-view="my-order" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold transition-all duration-300"><i class="fas fa-shopping-basket mr-2"></i>Il Mio Ordine <span id="cart-count" class="bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 inline-flex items-center justify-center ml-1">0</span></button>
            <button data-view="all-orders" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold transition-all duration-300"><i class="fas fa-users mr-2"></i>Tutti gli Ordini</button>
        </nav>

        <main>
            <div id="menu-view" class="view">
                <div id="smart-sections" class="mb-8 space-y-6">
                    <div id="favorites-container" class="hidden">
                        <h3 class="text-xl font-bold mb-3 flex items-center"><i class="fas fa-star text-yellow-500 mr-2"></i> I Tuoi Preferiti</h3>
                        <div id="favorites-items" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
                    </div>
                    <div id="popular-container" class="hidden">
                        <h3 class="text-xl font-bold mb-3 flex items-center"><i class="fas fa-fire text-red-500 mr-2"></i> I Pi√π Richiesti di Oggi</h3>
                        <div id="popular-items" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
                    </div>
                </div>
                <h2 id="menu-title" class="text-2xl font-bold mb-4">Scegli cosa ordinare</h2>
                <div id="category-filters" class="flex items-center justify-center flex-wrap gap-2 mb-4"></div>
                <div id="diet-filters" class="flex items-center justify-center flex-wrap gap-2 mb-6 bg-white p-2 rounded-xl shadow-md"></div>
                
                <div class="flex justify-end mb-4">
                    <button id="toggle-calories" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center text-sm">
                        <i class="fas fa-toggle-off mr-2"></i>
                        <span id="toggle-calories-text">Mostra Calorie</span>
                    </button>
                </div>

                <div id="menu-items" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                <div id="allergen-legend" class="mt-8 bg-white p-4 rounded-xl shadow-md"></div>
            </div>

            <div id="my-order-view" class="view">
                <h2 class="text-2xl font-bold mb-4">Riepilogo del Tuo Ordine</h2>
                <div id="my-order-content" class="bg-white p-6 rounded-xl shadow-md"></div>
            </div>

            <div id="all-orders-view" class="view">
                 <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-bold">Riepilogo Ordini di Oggi</h2>
                    <div class="flex flex-wrap gap-2">
                        <button id="copy-summary-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center"><i class="fas fa-copy mr-2"></i> Copia Riepilogo</button>
                        <button id="download-history-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center hidden"><i class="fas fa-database mr-2"></i> Scarica Storico</button>
                    </div>
                </div>
                <div id="payment-instructions" class="mb-6 bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-lg hidden"></div>
                <div id="all-orders-list" class="space-y-4"></div>
                 <div class="mt-6 bg-white p-4 rounded-xl shadow-lg text-right">
                    <span class="text-xl font-bold text-gray-800">Totale Complessivo di Oggi:</span>
                    <span id="grand-total" class="text-2xl font-bold text-blue-600 ml-2">‚Ç¨0.00</span>
                </div>
            </div>
        </main>
    </div>

    <div id="user-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-md text-center"><h3 class="text-2xl font-bold mb-4">Benvenuto!</h3><p class="text-gray-600 mb-6">Per iniziare, inserisci il tuo nome. <br><b class="text-red-600">Importante:</b> Usa lo stesso nome per il pagamento su Satispay.</p><input type="text" id="username-input" placeholder="Es. Marco Rossi" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition"><button id="save-username-btn" class="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">Salva e Continua</button></div></div>
    <div id="qr-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-md text-center relative"><button id="close-qr-modal-btn" class="absolute top-2 right-4 text-2xl text-gray-500 hover:text-gray-800">&times;</button><h3 class="text-2xl font-bold mb-4">Paga con Satispay</h3><p class="text-gray-600 mb-4">Inquadra questo QR code per pagare.</p><img id="qr-code-image" src="" alt="QR Code Satispay" class="mx-auto rounded-lg shadow-md w-full max-w-xs"></div></div>
    <div id="calorie-info-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-md relative"><button id="close-calorie-info-btn" class="absolute top-2 right-4 text-2xl text-gray-500 hover:text-gray-800">&times;</button><h3 class="text-2xl font-bold mb-4">Info Calorie</h3><div class="text-gray-600 text-sm space-y-2"><p>I valori stimati si basano su valori medi dei prodotti presenti nel mercato e disponibili pubblicamente. Ovviamente, in base alla composizione specifica dei singoli prodotti, non essendo industriali, sono unici ed √® possibile effettuare solo stime indicative.</p></div></div></div>
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-3 px-6 rounded-full shadow-xl transition-all duration-300 opacity-0 z-50"><p id="toast-message"></p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, deleteDoc, serverTimestamp, updateDoc, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCQJsNbgaR89gF_1vLe6H4DPboOhQvm9nI", authDomain: "app-ordini-pranzo-alimentari.firebaseapp.com", projectId: "app-ordini-pranzo-alimentari", storageBucket: "app-ordini-pranzo-alimentari.appspot.com", messagingSenderId: "553169964686", appId: "1:553169964686:web:7f8ca6f32a301949e4c3df" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const SERVICE_ACTIVE = true;
        const ADMIN_EMAIL = "marco.tranquilli@dos.design";
        const SATISPAY_URL = "https://web.satispay.com/app/open/shops/986e3af6-8a54-4c3d-9c23-b741ca0f8cc0";
        const QR_CODE_IMAGE_URL = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(SATISPAY_URL)}`;
        const MERCHANT_INFO = { name: "Alimentari Russo" };
        const ordersCollectionRef = collection(db, "orders");
        const PRICES = { gastronomia: 4.00, verdure: 4.00, panini: 3.50, pizze: 3.50, fritti: 1.50, dessert: 3.00 };
        const ALLERGENS = { G: { name: "Glutine", icon: "üåæ" }, L: { name: "Latticini", icon: "ü•õ" }, C: { name: "Crostacei", icon: "ü¶ê" }, P: { name: "Pesce", icon: "üêü" }};
        const DIETS = { vegetariano: { name: "Vegetariano", icon: "üßÄ" }, vegano: { name: "Vegano", icon: "üå±" }, "carne/pesce": { name: "Carne/üêüPesce", icon: "ü•©" } };
        const RAW_MENU = { gastronomia: [ { name: "Cous cous vegetale con pollo", allergens: ["G"], diet: ["carne/pesce"], calories: 450 }, { name: "Cous cous vegetale", allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 350 }, { name: "Farro vegetale", allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 380 }, { name: "Farro vegetale con salmone", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 480 }, { name: "Riso Venere con gamberi e zucchine", allergens: ["C"], diet: ["carne/pesce"], calories: 420 }, { name: "Insalata di riso", allergens: [], diet: ["carne/pesce"], calories: 400 }, { name: "Pasta fredda con tonno pomodori e olive", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 450 }, { name: "Pasta fredda pesto primo sale pomodori olive", allergens: ["G", "L"], diet: ["vegetariano"], calories: 500 }, { name: "Insalata di pollo", allergens: [], diet: ["carne/pesce"], calories: 350 }, { name: "Riso integrale bresaola limone e rughetta", allergens: [], diet: ["carne/pesce"], calories: 380 }, { name: "Pomodori con riso e patate (a peso)", allergens: [], diet: ["vegetariano", "vegano"], calories: 300 } ], dessert: [ { name: "Macedonia", allergens: [], diet: ["vegetariano", "vegano"], calories: 120 } ], fritti: [ { name: "Suppl√¨", allergens: ["G", "L"], diet: ["vegetariano"], calories: 250 }, { name: "Polpetta di melanzane", allergens: ["G", "L"], diet: ["vegetariano"], calories: 180 } ], verdure: [ { name: "Melanzane (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 180 }, { name: "Zucchine (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 160 }, { name: "Peperoni (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 160 }, { name: "Cicoria (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 140 }, { name: "Broccoletti (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 150 }, { name: "Broccoli (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 150 }, { name: "Scarola con olive (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 130 } ], panini: [ { name: "Crudo pomodoro mozzarella", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 550 }, { name: "Crudo stracchino rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 580 }, { name: "Cotto arrosto scamorza e verdura", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 520 }, { name: "Capocollo pecorino e pomodori secchi", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 600 }, { name: "Salame pecorino e pomodori secchi", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 620 }, { name: "Speck Brie e pomodori secchi", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 610 }, { name: "Porchetta", allergens: ["G"], diet: ["carne/pesce"], calories: 650 }, { name: "Vegetariano melanzane zucchine e peperoni", allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 450 }, { name: "Pane 5 cereali con tacchino e verdura", allergens: ["G"], diet: ["carne/pesce"], calories: 480 }, { name: "Pane integrale bresaola parmigiano e rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 500 }, { name: "Pane arabo bresaola primo sale e rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 470 }, { name: "Pane ai cereali con salmone e formaggio", allergens: ["G", "L", "P"], diet: ["carne/pesce"], calories: 530 }, { name: "Tonno e pomodoro", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 490 }, { name: "Tonno e carciofini", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 510 } ], pizze: [ { name: "Crudo e mozzarella", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 600 }, { name: "Speck stracchino e rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 650 }, { name: "Cotto arrosto e melanzane", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 580 }, { name: "Mortadella e stracciatella", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 700 }, { name: "Frittata e zucchine", allergens: ["G", "L"], diet: ["vegetariano"], calories: 550 }, { name: "Pizza 5 cereali bresaola e formaggio", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 580 }, { name: "Pizza 5 cereali con insalata di pollo", allergens: ["G"], diet: ["carne/pesce"], calories: 560 }, { name: "Focaccia ‚Äúgenovese‚Äù cotto e stracchino", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 620 } ] };
        
        const state = { currentUser: null, firestoreListener: null, currentView: 'menu', activeCategoryFilter: 'all', activeDietFilter: 'all', cart: [], selectingAlternativeFor: null, allOrders: [], menuData: processMenuData(RAW_MENU, PRICES), caloriesVisible: false };
        const dom = { views: document.querySelectorAll('.view'), navBtns: document.querySelectorAll('.nav-btn'), menuTitle: document.getElementById('menu-title'), menuItemsContainer: document.getElementById('menu-items'), categoryFiltersContainer: document.getElementById('category-filters'), dietFiltersContainer: document.getElementById('diet-filters'), allergenLegendContainer: document.getElementById('allergen-legend'), cartCountEl: document.getElementById('cart-count'), myOrderContentEl: document.getElementById('my-order-content'), allOrdersListEl: document.getElementById('all-orders-list'), grandTotalEl: document.getElementById('grand-total'), copySummaryBtn: document.getElementById('copy-summary-btn'), downloadHistoryBtn: document.getElementById('download-history-btn'), userModal: document.getElementById('user-modal'), usernameInput: document.getElementById('username-input'), saveUsernameBtn: document.getElementById('save-username-btn'), paymentInstructions: document.getElementById('payment-instructions'), qrModal: document.getElementById('qr-modal'), qrCodeImage: document.getElementById('qr-code-image'), calorieInfoModal: document.getElementById('calorie-info-modal'), toastEl: document.getElementById('toast'), toastMessageEl: document.getElementById('toast-message'), toggleCaloriesBtn: document.getElementById('toggle-calories'), toggleCaloriesText: document.getElementById('toggle-calories-text') };
        
        function processMenuData(rawMenu, prices) { let id = 1; const icons = { gastronomia: 'fa-bowl-food', fritti: 'fa-stroopwafel', verdure: 'fa-carrot', panini: 'fa-bread-slice', pizze: 'fa-pizza-slice', dessert: 'fa-ice-cream' }; return Object.entries(rawMenu).flatMap(([cat, items]) => items.map(item => ({ id: id++, name: item.name, category: cat.charAt(0).toUpperCase() + cat.slice(1), price: prices[cat] || 0, icon: icons[cat] || 'fa-utensils', ...item }))) }
        function showToast(message, duration = 3000) { dom.toastMessageEl.textContent = message; dom.toastEl.classList.remove('opacity-0'); setTimeout(() => dom.toastEl.classList.add('opacity-0'), duration); }
        function navigate(viewName) { state.currentView = viewName; dom.views.forEach(v => v.classList.toggle('active', v.id === `${viewName}-view`)); dom.navBtns.forEach(b => { b.classList.toggle('bg-blue-500', b.dataset.view === viewName); b.classList.toggle('text-white', b.dataset.view === viewName); }); window.scrollTo(0, 0); }
        const isOrderTimeBlocked = () => { const now = new Date(); return now.getHours() > 11 || (now.getHours() === 11 && now.getMinutes() >= 30); };
        
        function renderFilters() { let catHtml = `<button data-category="all" class="category-filter-btn py-2 px-4 rounded-full font-semibold transition-all duration-300 ${state.activeCategoryFilter === 'all' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'}">Tutte</button>`; Object.keys(RAW_MENU).forEach(cat => { catHtml += `<button data-category="${cat}" class="category-filter-btn py-2 px-4 rounded-full font-semibold transition-all duration-300 ${state.activeCategoryFilter === cat ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</button>`; }); dom.categoryFiltersContainer.innerHTML = catHtml; let dietHtml = `<button data-diet="all" class="diet-filter-btn flex items-center gap-2 py-2 px-4 rounded-lg font-semibold transition-all duration-300 ${state.activeDietFilter === 'all' ? 'bg-blue-500 text-white' : 'bg-gray-200'}">üçΩÔ∏è<span>Tutti</span></button>`; Object.entries(DIETS).forEach(([key, info]) => { dietHtml += `<button data-diet="${key}" class="diet-filter-btn flex items-center gap-2 py-2 px-4 rounded-lg font-semibold transition-all duration-300 ${state.activeDietFilter === key ? 'bg-blue-500 text-white' : 'bg-gray-200'}"><span>${info.icon}</span><span>${info.name}</span></button>`; }); dom.dietFiltersContainer.innerHTML = dietHtml; let legendHtml = '<p class="font-bold mb-2">Legenda Allergeni:</p><div class="flex flex-wrap gap-x-4 gap-y-2">'; Object.values(ALLERGENS).forEach(info => { legendHtml += `<span class="flex items-center text-sm">${info.icon} ${info.name}</span>`; }); legendHtml += '</div>'; dom.allergenLegendContainer.innerHTML = legendHtml; }
        function renderMenu() {
            dom.menuTitle.textContent = state.selectingAlternativeFor ? "Scegli un'alternativa" : "Scegli cosa ordinare";
            const filtered = state.menuData.filter(item => (state.activeCategoryFilter === 'all' || item.category.toLowerCase() === state.activeCategoryFilter) && (state.activeDietFilter === 'all' || item.diet.includes(state.activeDietFilter) || item.diet.includes('onnivoro')));
            if (filtered.length === 0) { dom.menuItemsContainer.innerHTML = `<div class="text-center p-8 bg-white rounded-xl shadow-md col-span-full"><p class="text-gray-500">Nessun piatto trovato.</p></div>`; return; }
            dom.menuItemsContainer.innerHTML = filtered.map(item => {
                const allergenHtml = item.allergens.map(key => `<span title="${ALLERGENS[key].name}">${ALLERGENS[key].icon}</span>`).join('');
                const btnHtml = state.selectingAlternativeFor ? `<button data-id="${item.id}" class="select-as-alternative-btn w-full mt-4 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-colors"><i class="fas fa-check"></i> Seleziona</button>` : `<button data-id="${item.id}" class="add-to-cart-btn w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors"><i class="fas fa-plus"></i> Aggiungi</button>`;
                return `<div class="bg-white p-4 rounded-xl shadow-md hover:shadow-lg transition-shadow flex flex-col"><div class="flex-grow"><div class="flex items-center mb-2"><i class="fas ${item.icon} text-blue-500 text-xl mr-3 w-6 text-center"></i><h3 class="font-bold text-lg">${item.name}</h3></div><p class="text-gray-600 ml-9">${item.category}</p></div><div class="flex justify-between items-center mt-4"><div class="flex gap-3 text-lg">${allergenHtml}</div><span class="font-semibold text-lg">‚Ç¨${item.price.toFixed(2)}</span></div><p class="calorie-info text-xs text-gray-500 text-right mt-1 flex items-center justify-end" style="display: ${state.caloriesVisible ? 'flex' : 'none'};">~${item.calories} kcal <button class="show-calorie-info-btn ml-1 text-blue-500 hover:text-blue-700 text-base"><i class="fas fa-info-circle"></i></button></p>${btnHtml}</div>`;
            }).join('');
        }
        function renderPaymentInstructions() { if (state.allOrders.length > 0) { dom.paymentInstructions.innerHTML = `<p class="font-bold">Come pagare:</p><p>1. Paga la tua quota a <span class="font-semibold">${MERCHANT_INFO.name}</span>.</p><div class="flex flex-wrap gap-2 mt-2"><a href="${SATISPAY_URL}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg inline-flex items-center transition-colors"><i class="fab fa-satispay mr-2"></i> Paga (App)</a><button id="show-qr-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg inline-flex items-center transition-colors"><i class="fas fa-qrcode mr-2"></i> Mostra QR</button></div><p class="mt-3">2. Dopo aver pagato, <span class="font-bold">spunta la casella "Pagato"</span>.</p><p class="text-sm mt-2 text-red-700"><b>Importante:</b> Usa lo stesso nome dell'ordine quando paghi.</p>`; dom.paymentInstructions.classList.remove('hidden'); } else { dom.paymentInstructions.classList.add('hidden'); } }
        function renderMyOrder() { dom.cartCountEl.textContent = state.cart.length; if (!state.currentUser || !state.currentUser.name) { dom.myOrderContentEl.innerHTML = `<p class="text-center text-gray-500">Inserisci il tuo nome per ordinare.</p>`; return; } const userOrder = state.allOrders.find(o => o.userId === state.currentUser.uid && !o.paid); if (userOrder) { let html = userOrder.items.map(item => `<div class="flex justify-between items-center py-2 border-b"><span>${item.name} (x${item.quantity})</span><span class="font-semibold">‚Ç¨${(item.price * item.quantity).toFixed(2)}</span></div>`).join(''); dom.myOrderContentEl.innerHTML = `<p class="text-lg font-semibold mb-2">Ciao ${state.currentUser.name}, questo √® il tuo ordine:</p><div class="space-y-2 mb-4">${html}</div><div class="text-right font-bold text-xl my-4">Totale: ‚Ç¨${userOrder.total.toFixed(2)}</div><button id="delete-my-order-btn" data-id="${userOrder.id}" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors"><i class="fas fa-trash-alt mr-2"></i> Cancella ordine</button>`; } else if (state.cart.length > 0) { let html = state.cart.map(item => `<div class="py-2 border-b"><div class="flex justify-between items-center"><span>${item.name}</span><div class="flex items-center gap-2"><span class="font-semibold">‚Ç¨${item.price.toFixed(2)}</span><button data-cart-item-id="${item.cartItemId}" class="remove-from-cart-btn text-red-500 hover:text-red-700 text-sm"><i class="fas fa-times-circle"></i></button></div></div><div class="mt-2"><p class="text-xs text-gray-500">Alternativa: <span class="font-semibold">${item.alternativeChoice || 'Nessuna'}</span></p><button data-cart-item-id="${item.cartItemId}" class="select-alternative-btn text-xs text-blue-600 hover:underline mt-1">${item.alternativeChoice ? 'Modifica' : 'Scegli'}</button></div></div>`).join(''); const total = state.cart.reduce((s, i) => s + i.price, 0); const calories = state.cart.reduce((s, i) => s + (i.calories || 0), 0); const blocked = isOrderTimeBlocked() || !SERVICE_ACTIVE; dom.myOrderContentEl.innerHTML = `<div class="space-y-2 mb-4">${html}</div><textarea id="order-notes" class="w-full p-2 border rounded-lg mt-4" placeholder="Note per la preparazione..."></textarea><div class="mt-4"><p class="font-semibold mb-2">Pagamento:</p><div class="flex gap-4"><label class="flex items-center"><input type="radio" name="paymentMethod" value="Satispay" class="mr-2" checked> Satispay</label><label class="flex items-center"><input type="radio" name="paymentMethod" value="Contanti/Carta" class="mr-2"> Contanti/Carta</label></div></div><div class="text-right font-bold text-xl my-4"><span>Totale: ‚Ç¨${total.toFixed(2)}</span><span class="calorie-info text-sm font-normal text-gray-500 flex items-center justify-end" style="display: ${state.caloriesVisible ? 'flex' : 'none'};">(~${calories} kcal)<button class="show-calorie-info-btn ml-1 text-blue-500 hover:text-blue-700 text-base"><i class="fas fa-info-circle"></i></button></span></div><button id="confirm-order-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-colors ${blocked ? 'opacity-50 cursor-not-allowed' : ''}" ${blocked ? 'disabled' : ''}><i class="fas fa-check-circle mr-2"></i> Conferma Ordine</button>${!SERVICE_ACTIVE ? `<p class="text-xs text-red-600 text-center mt-2">Il servizio √® sospeso.</p>` : isOrderTimeBlocked() ? `<p class="text-xs text-red-600 text-center mt-2">Ordini chiusi.</p>` : `<p class="text-xs text-gray-500 text-center mt-2">L'ordine sar√† aggiunto alla lista.</p>`}`; } else { dom.myOrderContentEl.innerHTML = `<p class="text-center text-gray-500 py-8">Il tuo carrello √® vuoto.</p>`; } }
        function renderAllOrders() { renderPaymentInstructions(); if (state.allOrders.length === 0) { dom.allOrdersListEl.innerHTML = `<div class="text-center bg-white p-8 rounded-xl shadow"><p class="text-gray-500">Nessun ordine per oggi.</p></div>`; dom.grandTotalEl.textContent = '‚Ç¨0.00'; return; } dom.allOrdersListEl.innerHTML = ''; let grandTotal = 0; state.allOrders.forEach(order => { grandTotal += order.total; const isMyOrder = state.currentUser.uid === order.userId; const card = document.createElement('div'); card.className = `bg-white p-4 rounded-xl shadow-md transition-opacity duration-300 ${order.paid ? 'paid-order' : ''}`; let html = order.items.map(i => `<li>${i.quantity}x ${i.name}${i.alternativeChoice ? `<span class="text-xs text-gray-500 block ml-4">‚Ü≥ Alt: ${i.alternativeChoice}</span>` : ''}</li>`).join(''); card.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-bold text-lg flex items-center">${order.userName}<span class="ml-2 text-xs font-semibold py-0.5 px-2 rounded-full ${order.paymentMethod === 'Satispay' ? 'bg-blue-200 text-blue-800' : 'bg-green-200 text-green-800'}">${order.paymentMethod}</span></p><ul class="list-disc list-inside text-gray-700 mt-2">${html}</ul>${order.notes ? `<p class="text-sm text-gray-500 mt-2"><em>Note: ${order.notes}</em></p>` : ''}</div><div class="text-right"><p class="font-semibold text-lg">‚Ç¨${order.total.toFixed(2)}</p><p class="text-xs text-gray-400 mt-1"><i class="far fa-clock"></i> ${order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : ''}</p>${isMyOrder && !order.paid ? `<button data-id="${order.id}" class="delete-my-order-btn text-red-500 hover:text-red-700 text-xs mt-2">Cancella</button>` : ''}</div></div><div class="border-t mt-3 pt-3 flex justify-end items-center"><label class="flex items-center ${isMyOrder ? 'cursor-pointer' : 'cursor-not-allowed'}"><input type="checkbox" data-order-id="${order.id}" class="paid-checkbox h-5 w-5 rounded text-blue-600 focus:ring-blue-500" ${order.paid ? 'checked' : ''} ${!isMyOrder ? 'disabled' : ''}><span class="ml-2 text-sm font-medium ${order.paid ? 'text-green-600' : 'text-gray-600'}">${order.paid ? 'Pagato' : 'Da pagare'}</span>${order.paid ? '<i class="fas fa-check-circle text-green-600 ml-2"></i>' : ''}</label></div>`; dom.allOrdersListEl.appendChild(card); }); dom.grandTotalEl.textContent = `‚Ç¨${grandTotal.toFixed(2)}`; }
        
        window.adminLogin = async (email, password) => { try { await signInWithEmailAndPassword(auth, email, password); showToast("Accesso admin riuscito!"); } catch (e) { console.error("Errore login admin:", e); showToast("Credenziali admin errate."); } }
        async function exportOrderHistoryToCSV() { showToast("Caricamento storico in corso..."); try { const querySnapshot = await getDocs(ordersCollectionRef); const allHistoricalOrders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (allHistoricalOrders.length === 0) { showToast("Nessun ordine trovato nello storico."); return; } const date = new Date().toISOString().slice(0, 10); generateAndDownloadCsv(allHistoricalOrders, `storico_ordini_completo_${date}.csv`); } catch (error) { console.error("Errore nel recupero dello storico:", error); showToast("Impossibile caricare lo storico."); } }
        function generateAndDownloadCsv(orders, fileName) { const headers = [ "ID Ordine", "ID Utente", "Data Ordine", "Giorno Settimana", "Nome Utente", "Totale Ordine (‚Ç¨)", "Categoria Prodotto", "Prodotto", "Quantit√†", "Prezzo Unitario (‚Ç¨)", "Totale Riga (‚Ç¨)", "Alternativa Suggerita", "Note Ordine", "Metodo Pagamento", "Pagato" ]; let csvContent = "\uFEFF" + headers.join(",") + "\n"; orders.forEach(order => { const timestamp = order.createdAt ? new Date(order.createdAt.seconds * 1000) : null; const orderDate = timestamp ? timestamp.toLocaleString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Data non disponibile'; const dayOfWeek = timestamp ? timestamp.toLocaleDateString('it-IT', { weekday: 'long' }) : 'N/D'; order.items.forEach(item => { const row = [ order.id, order.userId || 'N/D', `"${orderDate}"`, dayOfWeek, `"${(order.userName || '').replace(/"/g, '""')}"`, (order.total || 0).toFixed(2), item.category || 'N/D', `"${(item.name || '').replace(/"/g, '""')}"`, item.quantity || 1, (item.price || 0).toFixed(2), (item.price * item.quantity).toFixed(2), `"${(item.alternativeChoice || '').replace(/"/g, '""')}"`, `"${(order.notes || '').replace(/"/g, '""')}"`, order.paymentMethod || 'N/D', order.paid ? "Si" : "No" ]; csvContent += row.join(",") + "\n"; }); }); downloadFile(csvContent, fileName); }
        function downloadFile(content, fileName) { const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", fileName); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
        
        async function handlePaymentStatusChange(checkbox) { const id = checkbox.dataset.orderId; try { await updateDoc(doc(db, "orders", id), { paid: checkbox.checked }); showToast(`Stato pagamento aggiornato!`); } catch (e) { console.error(e); showToast("Errore aggiornamento."); checkbox.checked = !checkbox.checked; } }
        async function handleConfirmOrder() { if (state.cart.length === 0) return; const grouped = state.cart.reduce((acc, item) => { if (!acc[item.id]) { acc[item.id] = { ...item, quantity: 0 }; } acc[item.id].quantity++; if (item.alternativeChoice) acc[item.id].alternativeChoice = item.alternativeChoice; return acc; }, {}); const orderData = { userId: state.currentUser.uid, userName: state.currentUser.name, items: Object.values(grouped), total: Object.values(grouped).reduce((s, i) => s + (i.price * i.quantity), 0), notes: document.getElementById('order-notes').value.trim(), createdAt: serverTimestamp(), paid: false, paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value }; try { await addDoc(ordersCollectionRef, orderData); state.cart = []; showToast("Ordine confermato!"); renderMyOrder(); navigate('all-orders'); } catch (e) { console.error(e); showToast(`Errore: ${e.message}`); } }
        async function handleDeleteOrder(orderId) { try { await deleteDoc(doc(ordersCollectionRef, orderId)); showToast("Ordine cancellato."); } catch (e) { console.error(e); showToast("Errore cancellazione."); } }
        function handleCopySummary() { const orders = state.allOrders.filter(o => !o.paid); if (orders.length === 0) { showToast("Nessun ordine da pagare da inviare."); return; } const summary = {}; orders.forEach(order => { order.items.forEach(item => { const cat = item.category || 'Varie'; if (!summary[cat]) summary[cat] = {}; summary[cat][item.name] = (summary[cat][item.name] || 0) + item.quantity; }); }); let text = `*Ordine Pranzo per DOS Design* ü•™\n\n*RIEPILOGO PRODOTTI*\n-----------------------------------\n`; Object.keys(summary).sort().forEach(cat => { text += `*${cat.toUpperCase()}*\n`; for (const [name, qty] of Object.entries(summary[cat])) { text += `${qty}x ${name}\n`; } text += `\n`; }); text += `*DETTAGLIO ORDINI DA PAGARE*\n-----------------------------------\n`; orders.forEach(order => { text += `\n*üë§ ${order.userName.toUpperCase()}*: (Tot: ‚Ç¨${order.total.toFixed(2)})\n`; order.items.forEach(item => { text += `- ${item.quantity}x ${item.name}\n`; if (item.alternativeChoice) text += `  _(Alt: ${item.alternativeChoice})_\n`; }); if (order.notes) text += `  _Note: ${order.notes}_\n`; }); text += `\n-----------------------------------\n*TOTALE DA PAGARE: ‚Ç¨${orders.reduce((s, o) => s + o.total, 0).toFixed(2)}*\n\nIndirizzo: *Via Arno, 52*.\nPer favore confermate e indicate un orario di consegna. Grazie!`; navigator.clipboard.writeText(text).then(() => showToast("Riepilogo copiato!", 3000)); }
        
        function calculateTopItems(orders, limit) { if (!orders || orders.length === 0) return []; const itemCounts = {}; orders.forEach(order => { order.items.forEach(item => { itemCounts[item.name] = (itemCounts[item.name] || 0) + item.quantity; }); }); const sortedItems = Object.entries(itemCounts).sort(([, countA], [, countB]) => countB - countA).slice(0, limit); return sortedItems.map(([name]) => state.menuData.find(item => item.name === name)).filter(Boolean); }
        function renderSmartSection(containerId, itemsContainerId, items) { const container = document.getElementById(containerId); const itemsContainer = document.getElementById(itemsContainerId); if (!container || !itemsContainer || items.length === 0) { if (container) container.classList.add('hidden'); return; } itemsContainer.innerHTML = items.map(item => { if (!item) return ''; return `<div class="bg-white p-3 rounded-xl shadow-md flex items-center gap-3 hover:shadow-lg transition-shadow"><div class="flex-grow"><p class="font-bold text-sm">${item.name}</p><p class="text-xs text-gray-500">‚Ç¨${item.price.toFixed(2)}</p></div><button data-id="${item.id}" class="add-to-cart-btn bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-full h-10 w-10 flex items-center justify-center flex-shrink-0"><i class="fas fa-plus"></i></button></div>`; }).join(''); container.classList.remove('hidden'); }
        async function fetchAndRenderUserFavorites() { if (!state.currentUser || !state.currentUser.isAnonymous) { document.getElementById('favorites-container').classList.add('hidden'); return; } try { const q = query(ordersCollectionRef, where("userId", "==", state.currentUser.uid)); const querySnapshot = await getDocs(q); const userHistory = querySnapshot.docs.map(doc => doc.data()); const favoriteItems = calculateTopItems(userHistory, 3); renderSmartSection('favorites-container', 'favorites-items', favoriteItems); } catch (error) { console.error("Errore recupero preferiti:", error); } }
        function renderPopularItems() { const popularItems = calculateTopItems(state.allOrders, 3); renderSmartSection('popular-container', 'popular-items', popularItems); }

        function handleEvents(event) { const buttonTarget = event.target.closest('button'); if (buttonTarget) handleClicks(buttonTarget); const checkboxTarget = event.target.closest('input[type="checkbox"].paid-checkbox'); if(checkboxTarget) handlePaymentStatusChange(checkboxTarget); }
        function handleClicks(target) {
            if (target.matches('.category-filter-btn')) { document.querySelectorAll('.category-filter-btn').forEach(b=>{b.classList.remove('bg-indigo-600','text-white'); b.classList.add('bg-gray-200', 'text-gray-700')}); target.classList.add('bg-indigo-600','text-white'); state.activeCategoryFilter = target.dataset.category; renderMenu(); }
            else if (target.matches('.diet-filter-btn')) { document.querySelectorAll('.diet-filter-btn').forEach(b=>{b.classList.remove('bg-blue-500','text-white'); b.classList.add('bg-gray-200')}); target.classList.add('bg-blue-500','text-white'); state.activeDietFilter = target.dataset.diet; renderMenu(); }
            else if (target.matches('.nav-btn')) navigate(target.dataset.view);
            else if (target.matches('.add-to-cart-btn')) { const item = state.menuData.find(i => i.id === parseInt(target.dataset.id)); if (item) { state.cart.push({ ...item, cartItemId: crypto.randomUUID(), alternativeChoice: '' }); renderMyOrder(); dom.cartCountEl.textContent = state.cart.length; showToast(`${item.name} aggiunto!`); } }
            else if (target.matches('.select-as-alternative-btn')) { const item = state.menuData.find(i => i.id === parseInt(target.dataset.id)); const cartItem = state.cart.find(ci => ci.cartItemId === state.selectingAlternativeFor); if (item && cartItem) { cartItem.alternativeChoice = item.name; state.selectingAlternativeFor = null; renderMenu(); navigate('my-order'); renderMyOrder(); } }
            else if (target.matches('.select-alternative-btn')) { state.selectingAlternativeFor = target.dataset.cartItemId; navigate('menu'); renderMenu(); }
            else if (target.matches('.remove-from-cart-btn')) { const idx = state.cart.findIndex(i => i.cartItemId === target.dataset.cartItemId); if (idx > -1) { const removed = state.cart.splice(idx, 1)[0]; renderMyOrder(); showToast(`${removed.name} rimosso.`); } }
            else if (target.id === 'confirm-order-btn') handleConfirmOrder();
            else if (target.matches('.delete-my-order-btn')) handleDeleteOrder(target.dataset.id);
            else if (target.id === 'save-username-btn') { const name = dom.usernameInput.value.trim(); if (name) { localStorage.setItem('lunch-order-username', name); state.currentUser.name = name; dom.userModal.classList.add('hidden'); renderMyOrder(); } else showToast('Inserisci un nome.'); }
            else if (target.id === 'copy-summary-btn') handleCopySummary();
            else if (target.id === 'download-history-btn') exportOrderHistoryToCSV();
            else if (target.id === 'show-qr-btn') { dom.qrCodeImage.src = QR_CODE_IMAGE_URL; dom.qrModal.classList.remove('hidden'); }
            else if (target.id === 'close-qr-modal-btn') dom.qrModal.classList.add('hidden');
            else if (target.matches('.show-calorie-info-btn')) dom.calorieInfoModal.classList.remove('hidden');
            else if (target.id === 'close-calorie-info-btn') dom.calorieInfoModal.classList.add('hidden');
            else if (target.id === 'toggle-calories') { 
                state.caloriesVisible = !state.caloriesVisible;
                const icon = target.querySelector('i');
                if (state.caloriesVisible) {
                    dom.toggleCaloriesText.textContent = 'Nascondi Calorie';
                    icon.classList.remove('fa-toggle-off');
                    icon.classList.add('fa-toggle-on');
                } else {
                    dom.toggleCaloriesText.textContent = 'Mostra Calorie';
                    icon.classList.remove('fa-toggle-on');
                    icon.classList.add('fa-toggle-off');
                }
                renderMenu();
                renderMyOrder();
            }
        }

        function init() {
            document.body.addEventListener('click', handleEvents);
            document.body.addEventListener('change', handleEvents);
            renderFilters();
            renderMenu();
            navigate('menu');
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const isNewUser = !state.currentUser || state.currentUser.uid !== user.uid;
                if (isNewUser) {
                    state.currentUser = { uid: user.uid, isAnonymous: user.isAnonymous, email: user.email };
                    if (user.email === ADMIN_EMAIL) {
                        dom.downloadHistoryBtn.classList.remove('hidden');
                        dom.userModal.classList.add('hidden');
                        document.getElementById('favorites-container').classList.add('hidden');
                        document.getElementById('popular-container').classList.add('hidden');
                    } else {
                        dom.downloadHistoryBtn.classList.add('hidden');
                        const savedName = localStorage.getItem('lunch-order-username');
                        if (savedName) { state.currentUser.name = savedName; } else { dom.userModal.classList.add('hidden'); }
                        fetchAndRenderUserFavorites();
                    }
                    if (state.firestoreListener) state.firestoreListener();
                    state.firestoreListener = onSnapshot(ordersCollectionRef, (snapshot) => {
                        const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                        state.allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(o => o.createdAt && o.createdAt.toDate() >= todayStart);
                        renderAllOrders();
                        renderMyOrder();
                        if (state.currentUser && !state.currentUser.email) { renderPopularItems(); }
                    }, (error) => { console.error("Errore Firestore:", error); showToast("Errore di connessione al db."); });
                }
            } else {
                signInAnonymously(auth).catch(e => console.error("Accesso anonimo fallito", e));
            }
        });
        
        init();
    </script>
</body>
</html>
}