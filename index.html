<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dosemagna</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .paid-order { opacity: 0.6; transition: opacity 0.3s ease-in-out; }
        #favorites-section .overflow-x-auto::-webkit-scrollbar { height: 6px; }
        #favorites-section .overflow-x-auto::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #favorites-section .overflow-x-auto::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        #favorites-section .overflow-x-auto::-webkit-scrollbar-thumb:hover { background: #aaa; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
        <header class="mb-6 flex flex-col items-center">
            <img src="https://i.postimg.cc/Nf321BV0/dosemagna-logo-neutro.png" alt="Dosemagna Logo" class="w-64 md:w-80 mx-auto">
            <p class="text-center text-gray-500 -mt-2 md:-mt-4 italic">‚ÄúDal pizzicarolo alla scrivania‚Äù</p>
            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-md my-4 w-full" role="alert">
                <p class="font-bold">Attenzione: L'ordine e il pagamento con Satispay devono essere completati entro le 11:30.</p>
                <p>La consegna √® stimata intorno alle 12:30.</p>
            </div>
        </header>

        <nav class="flex justify-center bg-white p-2 rounded-xl shadow-md mb-6 sticky top-4 z-10">
            <button data-view="menu" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold"><i class="fas fa-utensils mr-2"></i>Men√π</button>
            <button data-view="my-order" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold"><i class="fas fa-shopping-basket mr-2"></i>Il Mio Ordine <span id="cart-count" class="bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 inline-flex items-center justify-center ml-1">0</span></button>
            <button data-view="all-orders" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold"><i class="fas fa-users mr-2"></i>Tutti gli Ordini</button>
        </nav>

        <main>
            <div id="menu-view" class="view">
                <h2 class="text-3xl font-extrabold mb-4">Scegli cosa ordinare</h2>
                
                <div id="favorites-section" class="mb-8"></div>
                
                <div class="flex flex-col sm:flex-row gap-3 mb-4 items-center">
                    <div class="relative w-full sm:flex-grow">
                        <input type="search" id="search-input" placeholder="Cerca un piatto..." class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <select id="category-select" class="w-full sm:w-auto p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-2 focus:ring-indigo-500"></select>
                    <select id="diet-select" class="w-full sm:w-auto p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-2 focus:ring-indigo-500"></select>
                </div>
                
                <div class="flex justify-between items-center mb-4">
                    <div id="filter-counter-container" class="text-sm text-gray-600"></div>
                    <div class="flex gap-2">
                        <button id="show-allergens-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg flex items-center text-sm"><i class="fas fa-info-circle mr-2"></i> Mostra Allergeni</button>
                        <button id="toggle-calories" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg flex items-center text-sm">
                            <i class="fas fa-toggle-off mr-2"></i>
                            <span id="toggle-calories-text">Mostra Calorie</span>
                        </button>
                    </div>
                </div>

                <div id="menu-items" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <div id="my-order-view" class="view">
                <h2 class="text-3xl font-extrabold mb-4">Riepilogo del Tuo Ordine</h2>
                <div id="my-order-content" class="bg-white p-6 rounded-xl shadow-md"></div>
            </div>

            <div id="all-orders-view" class="view">
                 <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-3xl font-extrabold">Riepilogo Ordini di Oggi</h2>
                    <button id="copy-summary-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-copy mr-2"></i> Copia Riepilogo</button>
                </div>
                <div id="all-orders-list" class="space-y-4"></div>
                 <div class="mt-6 bg-white p-4 rounded-xl shadow-lg text-right">
                    <span class="text-xl font-bold text-gray-800">Totale Complessivo:</span>
                    <span id="grand-total" class="text-2xl font-bold text-blue-600 ml-2">‚Ç¨0.00</span>
                </div>
            </div>
        </main>
    </div>

    <div id="user-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-md text-center"><h3 class="text-2xl font-bold mb-4">Benvenuto!</h3><p class="text-gray-600 mb-6">Per iniziare, inserisci il tuo nome.</p><input type="text" id="username-input" placeholder="Es. Marco Rossi" class="w-full p-3 border rounded-lg"><button id="save-username-btn" class="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">Salva</button></div></div>
    <div id="allergen-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-md relative"><button id="close-allergen-modal-btn" class="absolute top-2 right-4 text-2xl text-gray-500 hover:text-gray-800">&times;</button><h3 class="text-2xl font-bold mb-4">Legenda Allergeni</h3><div id="allergen-modal-content" class="text-gray-600 text-sm space-y-2"></div></div></div>
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-3 px-6 rounded-full shadow-xl z-50 opacity-0 transition-opacity"><p id="toast-message"></p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCQJsNbgaR89gF_1vLe6H4DPboOhQvm9nI", authDomain: "app-ordini-pranzo-alimentari.firebaseapp.com", projectId: "app-ordini-pranzo-alimentari", storageBucket: "app-ordini-pranzo-alimentari.appspot.com", messagingSenderId: "553169964686", appId: "1:553169964686:web:7f8ca6f32a301949e4c3df" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ordersCollectionRef = collection(db, "orders");
        
        const PRICES = { gastronomia: 4.00, verdure: 4.00, panini: 3.50, pizze: 3.50, fritti: 1.50, dessert: 3.00 };
        const ALLERGENS = { G: { name: "Glutine", icon: "fa-wheat-awn" }, L: { name: "Latticini", icon: "fa-cheese" }, C: { name: "Crostacei", icon: "fa-shrimp" }, P: { name: "Pesce", icon: "fa-fish-fins" }};
        const DIETS = { vegetariano: { name: "Vegetariano", icon: "üßÄ" }, vegano: { name: "Vegano", icon: "üå±" }, "carne/pesce": { name: "Carne/üêüPesce", icon: "ü•©" } };
        
        const BREAD_OPTIONS = {
            Panini: ["Pane classico", "Pane ai cereali", "Focaccia"],
            Pizze: ["Pizza classica", "Pizza 5 cereali"]
        };

        const RAW_MENU = {
            gastronomia: [ { name: "Cous cous vegetale con pollo", allergens: ["G"], diet: ["carne/pesce"], calories: 450, ingredients: ["Cous cous", "Verdure miste", "Pollo"] }, { name: "Cous cous vegetale", allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 350, ingredients: ["Cous cous", "Verdure miste"] }, { name: "Farro vegetale", allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 380, ingredients: ["Farro", "Verdure miste"] }, { name: "Farro vegetale con salmone", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 480, ingredients: ["Farro", "Verdure miste", "Salmone"] }, { name: "Riso Venere con gamberi e zucchine", allergens: ["C"], diet: ["carne/pesce"], calories: 420, ingredients: ["Riso Venere", "Gamberi", "Zucchine"] }, { name: "Insalata di riso", allergens: [], diet: ["carne/pesce"], calories: 400, ingredients: ["Riso", "Wurstel", "Uova", "Verdure sott'olio"] }, { name: "Pasta fredda con tonno pomodori e olive", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 450, ingredients: ["Pasta", "Tonno", "Pomodorini", "Olive"] }, { name: "Pasta fredda pesto primo sale pomodori olive", allergens: ["G", "L"], diet: ["vegetariano"], calories: 500, ingredients: ["Pasta", "Pesto", "Formaggio primo sale", "Pomodorini"] }, { name: "Insalata di pollo", allergens: [], diet: ["carne/pesce"], calories: 350, ingredients: ["Pollo", "Insalata", "Mais", "Pomodorini"] }, { name: "Riso integrale bresaola limone e rughetta", allergens: [], diet: ["carne/pesce"], calories: 380, ingredients: ["Riso integrale", "Bresaola", "Rucola", "Succo di limone"] }, { name: "Pomodori con riso e patate (a peso)", allergens: [], diet: ["vegetariano", "vegano"], calories: 300, ingredients: ["Pomodori", "Riso", "Patate"] } ],
            dessert: [ { name: "Macedonia", allergens: [], diet: ["vegetariano", "vegano"], calories: 120, ingredients: ["Frutta fresca di stagione"] } ],
            fritti: [ { name: "Suppl√¨", allergens: ["G", "L"], diet: ["vegetariano"], calories: 250, ingredients: ["Riso", "Pomodoro", "Mozzarella", "Pangrattato"] }, { name: "Polpetta di melanzane", allergens: ["G", "L"], diet: ["vegetariano"], calories: 180, ingredients: ["Melanzane", "Parmigiano", "Uova", "Pangrattato"] } ],
            verdure: [ { name: "Melanzane (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 180, ingredients: ["Melanzane grigliate"] }, { name: "Zucchine (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 160, ingredients: ["Zucchine grigliate"] }, { name: "Peperoni (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 160, ingredients: ["Peperoni arrostiti"] }, { name: "Cicoria (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 140, ingredients: ["Cicoria ripassata"] }, { name: "Broccoletti (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 150, ingredients: ["Broccoletti ripassati"] }, { name: "Broccoli (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 150, ingredients: ["Broccoli al vapore"] }, { name: "Scarola con olive (circa 200g)", allergens: [], diet: ["vegetariano", "vegano"], calories: 130, ingredients: ["Scarola", "Olive di Gaeta"] } ],
            panini: [ { name: "Crudo pomodoro mozzarella", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 550, ingredients: ["Prosciutto crudo", "Pomodoro", "Mozzarella"] }, { name: "Crudo stracchino rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 580, ingredients: ["Prosciutto crudo", "Stracchino", "Rucola"] }, { name: "Cotto arrosto scamorza e verdura", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 520, ingredients: ["Prosciutto cotto", "Scamorza", "Verdura di stagione"] }, { name: "Capocollo pecorino e pomodori secchi", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 600, ingredients: ["Capocollo", "Pecorino", "Pomodori secchi"] }, { name: "Salame pecorino e pomodori secchi", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 620, ingredients: ["Salame", "Pecorino", "Pomodori secchi"] }, { name: "Speck Brie e pomodori secchi", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 610, ingredients: ["Speck", "Brie", "Pomodori secchi"] }, { name: "Porchetta", allergens: ["G"], diet: ["carne/pesce"], calories: 650, ingredients: ["Porchetta di Ariccia"] }, { name: "Vegetariano melanzane zucchine e peperoni", allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 450, ingredients: ["Melanzane", "Zucchine", "Peperoni grigliati"] }, { name: "Tacchino e verdura", allergens: ["G"], diet: ["carne/pesce"], calories: 480, ingredients: ["Tacchino arrosto", "Verdura di stagione"] }, { name: "Bresaola parmigiano e rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 500, ingredients: ["Bresaola", "Parmigiano a scaglie", "Rucola"] }, { name: "Bresaola primo sale e rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 470, ingredients: ["Bresaola", "Primo sale", "Rucola"] }, { name: "Salmone e formaggio", allergens: ["G", "L", "P"], diet: ["carne/pesce"], calories: 530, ingredients: ["Salmone affumicato", "Formaggio spalmabile"] }, { name: "Tonno e pomodoro", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 490, ingredients: ["Tonno", "Pomodoro a fette"] }, { name: "Tonno e carciofini", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 510, ingredients: ["Tonno", "Carciofini sott'olio"] } ],
            pizze: [ { name: "Crudo e mozzarella", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 600, ingredients: ["Prosciutto crudo", "Mozzarella"] }, { name: "Speck stracchino e rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 650, ingredients: ["Speck", "Stracchino", "Rucola"] }, { name: "Cotto arrosto e melanzane", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 580, ingredients: ["Prosciutto cotto", "Melanzane"] }, { name: "Mortadella e stracciatella", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 700, ingredients: ["Mortadella", "Stracciatella"] }, { name: "Frittata e zucchine", allergens: ["G", "L"], diet: ["vegetariano"], calories: 550, ingredients: ["Frittata", "Zucchine"] }, { name: "Bresaola e formaggio", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 580, ingredients: ["Bresaola", "Formaggio"] }, { name: "Insalata di pollo", allergens: ["G"], diet: ["carne/pesce"], calories: 560, ingredients: ["Insalata di pollo"] }, { name: "Cotto e stracchino", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 620, ingredients: ["Prosciutto cotto", "Stracchino"] } ]
        };
        
        const state = { currentUser: null, currentView: 'menu', activeCategoryFilter: 'all', activeDietFilter: 'all', searchTerm: '', cart: [], allOrders: [], menuData: processMenuData(RAW_MENU, PRICES), caloriesVisible: false };
        const dom = { };
        
        function processMenuData(rawMenu, prices) { let id = 1; const icons = { gastronomia: 'fa-bowl-food', fritti: 'fa-stroopwafel', verdure: 'fa-carrot', panini: 'fa-bread-slice', pizze: 'fa-pizza-slice', dessert: 'fa-ice-cream' }; return Object.entries(rawMenu).flatMap(([cat, items]) => items.map(item => ({ id: id++, name: item.name, category: cat.charAt(0).toUpperCase() + cat.slice(1), price: prices[cat] || 0, icon: icons[cat] || 'fa-utensils', ...item }))) }
        function showToast(message, duration = 3000) { dom.toastMessageEl.textContent = message; dom.toastEl.classList.remove('opacity-0'); setTimeout(() => dom.toastEl.classList.add('opacity-0'), duration); }
        function navigate(viewName) { state.currentView = viewName; dom.views.forEach(v => v.classList.toggle('active', v.id === `${viewName}-view`)); dom.navBtns.forEach(b => { b.classList.toggle('bg-blue-500', b.dataset.view === viewName); b.classList.toggle('text-white', b.dataset.view === viewName); }); }
        
        function updateFilterCounter() {
            let count = 0; if (state.activeCategoryFilter !== 'all') count++; if (state.activeDietFilter !== 'all') count++; if(state.searchTerm) count++;
            dom.filterCounterContainer.innerHTML = count > 0 ? `<i class="fas fa-filter text-indigo-500"></i> ${count} ${count === 1 ? 'filtro applicato' : 'filtri applicati'}` : '';
        }

        function renderFilters() {
            let catSelectHtml = `<option value="all">Tutte le Categorie</option>`; Object.keys(RAW_MENU).forEach(cat => { catSelectHtml += `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`; }); dom.categorySelect.innerHTML = catSelectHtml;
            let dietSelectHtml = `<option value="all">Tutti i Regimi</option>`; Object.entries(DIETS).forEach(([key, info]) => { dietSelectHtml += `<option value="${key}">${info.icon} ${info.name}</option>`; }); dom.dietSelect.innerHTML = dietSelectHtml;
            let legendHtml = ''; Object.values(ALLERGENS).forEach(info => { legendHtml += `<p class="flex items-center text-base mb-1"><i class="fas ${info.icon} mr-2 text-gray-600"></i> ${info.name}</p>`; }); dom.allergenModalContent.innerHTML = legendHtml;
        }

        function renderMenu() {
            const term = state.searchTerm.toLowerCase();
            const filtered = state.menuData.filter(item => (item.name.toLowerCase().includes(term)) && (state.activeCategoryFilter === 'all' || item.category.toLowerCase() === state.activeCategoryFilter) && (state.activeDietFilter === 'all' || item.diet.includes(state.activeDietFilter)));
            
            if (filtered.length === 0) {
                 dom.menuItemsContainer.innerHTML = `<div class="text-center p-8 col-span-full bg-white rounded-xl shadow"><p class="text-gray-500">Nessun piatto trovato.</p></div>`;
                 return;
            }

            let currentCategory = '';
            let menuHtml = '';
            const sortedItems = filtered.sort((a, b) => a.category.localeCompare(b.category));

            sortedItems.forEach(item => {
                if (item.category !== currentCategory) {
                    currentCategory = item.category;
                    menuHtml += `<div class="col-span-full mt-6 mb-2"><h3 class="text-2xl font-bold text-gray-800 border-b-2 border-blue-200 pb-2">${currentCategory}</h3></div>`;
                }
                
                const allergenHtml = item.allergens.map(key => `<i class="fas ${ALLERGENS[key].icon}" title="${ALLERGENS[key].name}"></i>`).join(' ');
                
                menuHtml += `
                <div class="bg-white p-4 rounded-xl shadow-md flex flex-col">
                    <div class="flex-grow">
                        <div class="flex items-start mb-2">
                            <i class="fas ${item.icon} text-blue-500 text-xl mr-3 w-6 text-center pt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg">${item.name}</h3>
                                <p class="text-gray-500 text-sm">${item.category}</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-600 ml-9 mt-1"><span class="font-semibold">Ingredienti:</span> ${item.ingredients ? item.ingredients.join(', ') : 'Non specificati'}</p>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <div class="flex gap-3 text-lg items-center">${allergenHtml}</div>
                        <span class="font-semibold text-lg">‚Ç¨${item.price.toFixed(2)}</span>
                    </div>
                    <p class="calorie-info text-xs text-gray-500 text-right mt-1" style="display: ${state.caloriesVisible ? 'flex' : 'none'}; justify-content: flex-end; align-items: center;">
                        ~${item.calories} kcal <i class="fas fa-question-circle text-blue-500 ml-1 cursor-pointer calorie-info-icon"></i>
                    </p>
                    <button data-id="${item.id}" class="add-to-cart-btn w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i> Aggiungi</button>
                </div>`;
            });
            dom.menuItemsContainer.innerHTML = menuHtml;
        }

        function renderFavorites() {
            const favoritesContainer = document.getElementById('favorites-section');
            if (!state.allOrders || state.allOrders.length === 0) { favoritesContainer.innerHTML = ''; return; }
            const itemCounts = state.allOrders.flatMap(order => order.items.map(item => item.name.split(' (')[0])).reduce((acc, name) => { acc[name] = (acc[name] || 0) + 1; return acc; }, {});
            const sortedFavorites = Object.entries(itemCounts).sort(([, a], [, b]) => b - a).slice(0, 5).map(([name]) => state.menuData.find(item => item.name === name)).filter(Boolean); 
            if (sortedFavorites.length === 0) { favoritesContainer.innerHTML = ''; return; }
            const favoritesHtml = sortedFavorites.map(item => `<button data-id="${item.id}" class="add-to-cart-btn flex-shrink-0 bg-white p-3 rounded-lg shadow-sm hover:shadow-md transition-shadow text-left w-40"><p class="font-semibold text-sm truncate">${item.name}</p><p class="text-xs text-gray-500">‚Ç¨${item.price.toFixed(2)}</p></button>`).join('');
            favoritesContainer.innerHTML = `<h3 class="text-2xl font-bold mb-3"><i class="fas fa-star text-yellow-400 mr-2"></i>I Pi√π Ordinati</h3><div class="flex gap-3 overflow-x-auto pb-3">${favoritesHtml}</div>`;
        }
        
        function renderMyOrder() {
            const totalItems = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            dom.cartCountEl.textContent = totalItems;
            if (state.cart.length === 0) {
                dom.myOrderContentEl.innerHTML = `<p class="text-center text-gray-500 py-8">Il tuo carrello √® vuoto.</p>`;
                return;
            }
            const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemsHtml = state.cart.map(item => {
                let breadSelectorHtml = '';
                if (BREAD_OPTIONS[item.category]) {
                    const optionsHtml = BREAD_OPTIONS[item.category].map(opt => `<option value="${opt}" ${item.selectedType === opt ? 'selected' : ''}>${opt}</option>`).join('');
                    breadSelectorHtml = `<select data-id="${item.cartId}" class="cart-bread-select mt-2 w-full p-2 border border-gray-300 rounded-md text-sm">${optionsHtml}</select>`;
                }
                return `
                <div class="py-3 border-b">
                    <div class="flex justify-between items-start">
                        <div><p class="font-semibold">${item.name}</p><p class="text-sm text-gray-600">‚Ç¨${item.price.toFixed(2)}</p></div>
                        <div class="flex items-center gap-3">
                            <button data-id="${item.cartId}" data-action="decrease" class="cart-qty-btn bg-gray-200 rounded-full h-8 w-8">-</button>
                            <span class="font-bold text-lg">${item.quantity}</span>
                            <button data-id="${item.cartId}" data-action="increase" class="cart-qty-btn bg-gray-200 rounded-full h-8 w-8">+</button>
                            <button data-id="${item.cartId}" class="cart-remove-btn text-red-500 text-lg flex-shrink-0 ml-4"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    ${breadSelectorHtml}
                </div>`;
            }).join('');

            dom.myOrderContentEl.innerHTML = `
                <div class="space-y-2 mb-4">${itemsHtml}</div>
                <div class="mt-6">
                    <label for="alternative-input" class="block mb-2 font-semibold text-gray-700">Alternativa (se un prodotto √® esaurito):</label>
                    <input type="text" id="alternative-input" placeholder="Es. un suppl√¨ o un'altra verdura" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div class="text-right font-bold text-2xl my-4">Totale: ‚Ç¨${total.toFixed(2)}</div>
                <button id="confirm-order-btn" class="w-full mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg"><i class="fas fa-check-circle mr-2"></i>Conferma e Invia Ordine</button>
            `;
        }

        function renderAllOrders() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todaysOrders = state.allOrders.filter(order => order.createdAt && order.createdAt.toDate() >= today).sort((a, b) => a.createdAt - b.createdAt);
            
            if (todaysOrders.length === 0) {
                dom.allOrdersListEl.innerHTML = `<div class="text-center p-8 bg-white rounded-xl shadow"><p class="text-gray-500">Nessun ordine per oggi.</p></div>`;
                dom.grandTotalEl.textContent = '‚Ç¨0.00';
                return;
            }
            
            let grandTotal = 0;
            const ordersHtml = todaysOrders.map(order => {
                grandTotal += order.total;
                const itemsHtml = order.items.map(item => `<li class="flex justify-between items-center text-sm"><span>${item.quantity} x ${item.name} ${item.selectedType ? `(${item.selectedType})` : ''}</span><span class="font-medium">‚Ç¨${(item.price * item.quantity).toFixed(2)}</span></li>`).join('');
                const alternativeHtml = order.alternative ? `<p class="text-xs text-gray-500 mt-2 pl-4 border-l-2 border-orange-300"><b>Alternativa:</b> ${order.alternative}</p>` : '';
                return `
                    <div id="order-${order.id}" class="bg-white p-4 rounded-xl shadow-md ${order.paid ? 'paid-order' : ''}">
                        <div class="flex justify-between items-center border-b pb-2 mb-2">
                            <h4 class="font-bold text-lg">${order.user}</h4>
                            <span class="font-bold text-blue-600 text-lg">‚Ç¨${order.total.toFixed(2)}</span>
                        </div>
                        <ul class="space-y-1">${itemsHtml}</ul>
                        ${alternativeHtml}
                        <div class="text-right mt-3">
                             <label class="flex items-center justify-end text-sm cursor-pointer">
                                <input type="checkbox" data-id="${order.id}" class="toggle-paid-btn" ${order.paid ? 'checked' : ''}>
                                <span class="ml-2 ${order.paid ? 'text-green-600 font-semibold' : 'text-gray-600'}">Pagato con Satispay</span>
                            </label>
                        </div>
                    </div>`;
            }).join('');
            dom.allOrdersListEl.innerHTML = ordersHtml;
            dom.grandTotalEl.textContent = `‚Ç¨${grandTotal.toFixed(2)}`;
        }
        
        function handleCartSelectChange(selectElement) {
            const cartId = parseInt(selectElement.dataset.id);
            const newType = selectElement.value;
            const itemInCart = state.cart.find(i => i.cartId === cartId);
            if (itemInCart) itemInCart.selectedType = newType;
        }

        async function handlePaidToggle(checkbox) {
            const orderId = checkbox.dataset.id;
            const isPaid = checkbox.checked;
            if (!orderId) return;
            const orderRef = doc(db, "orders", orderId);
            try {
                await updateDoc(orderRef, { paid: isPaid });
                showToast(`Stato pagamento aggiornato.`);
            } catch (error) {
                console.error("Errore aggiornamento pagamento: ", error);
                showToast("Errore durante l'aggiornamento.", 4000);
                checkbox.checked = !isPaid;
            }
        }

        function handleEvents(event) {
            const target = event.target;
            if (event.type === 'click' && target.matches('.calorie-info-icon')) {
                showToast('Le calorie sono stime indicative e possono variare.');
            } else if (event.type === 'click' && target.closest('button')) {
                handleClicks(target.closest('button'));
            } else if (event.type === 'change' && target.matches('.cart-bread-select')) {
                handleCartSelectChange(target);
            } else if (event.type === 'change' && target.matches('.toggle-paid-btn')) {
                handlePaidToggle(target);
            } else if (event.type === 'change' && target.matches('select')) {
                handleSelectChange(target);
            } else if (event.type === 'input' && target.id === 'search-input') {
                state.searchTerm = target.value;
                updateFilterCounter();
                renderMenu();
            }
        }

        function handleSelectChange(target) {
            if (target.id === 'category-select') state.activeCategoryFilter = target.value;
            else if (target.id === 'diet-select') state.activeDietFilter = target.value;
            updateFilterCounter();
            renderMenu();
        }
        
        async function handleClicks(button) {
            if (button.matches('.nav-btn')) {
                navigate(button.dataset.view);
            }
            else if (button.matches('.add-to-cart-btn')) { 
                const item = state.menuData.find(i => i.id === parseInt(button.dataset.id));
                if (!item) return;
                const existingItem = state.cart.find(i => i.id === item.id);
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    let defaultType = (item.category === 'Panini') ? 'Pane classico' : (item.category === 'Pizze') ? 'Pizza classica' : null;
                    state.cart.push({ ...item, cartId: Date.now(), quantity: 1, selectedType: defaultType });
                }
                renderMyOrder();
                showToast(`${item.name} aggiunto!`);
            }
            else if (button.matches('.cart-qty-btn')) {
                const cartId = parseInt(button.dataset.id);
                const itemInCart = state.cart.find(i => i.cartId === cartId);
                if (itemInCart) {
                    if (button.dataset.action === 'increase') itemInCart.quantity++;
                    else if (button.dataset.action === 'decrease' && itemInCart.quantity > 1) itemInCart.quantity--;
                    else state.cart = state.cart.filter(i => i.cartId !== cartId);
                }
                renderMyOrder();
            }
            else if (button.matches('.cart-remove-btn')) {
                state.cart = state.cart.filter(i => i.cartId !== parseInt(button.dataset.id));
                renderMyOrder();
            }
            else if (button.id === 'save-username-btn') { 
                const name = dom.usernameInput.value.trim();
                if (name) {
                    localStorage.setItem('dosemagna-username', name);
                    state.currentUser.name = name;
                    dom.userModal.classList.add('hidden');
                }
            }
            else if (button.id === 'toggle-calories') { 
                state.caloriesVisible = !state.caloriesVisible;
                button.querySelector('span').textContent = state.caloriesVisible ? 'Nascondi Calorie' : 'Mostra Calorie';
                button.querySelector('i').className = `fas ${state.caloriesVisible ? 'fa-toggle-on' : 'fa-toggle-off'} mr-2`;
                renderMenu();
            }
            else if (button.id === 'show-allergens-btn') {
                dom.allergenModal.classList.remove('hidden');
            }
            else if (button.id === 'close-allergen-modal-btn') {
                dom.allergenModal.classList.add('hidden');
            }
            else if (button.id === 'confirm-order-btn') {
                if (state.cart.length === 0) { showToast("Il tuo carrello √® vuoto."); return; }
                if (!state.currentUser || !state.currentUser.name) { showToast("Per favore, inserisci prima il tuo nome."); dom.userModal.classList.remove('hidden'); return; }
                
                const alternative = document.getElementById('alternative-input').value.trim();
                const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const itemsToSave = state.cart.map(item => ({ name: item.name, quantity: item.quantity, price: item.price, selectedType: item.selectedType || null }));
                
                try {
                    await addDoc(ordersCollectionRef, { user: state.currentUser.name, uid: state.currentUser.uid, items: itemsToSave, total: total, alternative: alternative, createdAt: serverTimestamp(), paid: false });
                    showToast("Ordine confermato con successo!");
                    state.cart = [];
                    renderMyOrder();
                    navigate('all-orders');
                } catch (error) {
                    console.error("Errore nell'invio dell'ordine: ", error);
                    showToast("Si √® verificato un errore. Riprova.", 4000);
                }
            }
        }

        function init() {
            Object.assign(dom, {
                views: document.querySelectorAll('.view'), navBtns: document.querySelectorAll('.nav-btn'),
                menuItemsContainer: document.getElementById('menu-items'), cartCountEl: document.getElementById('cart-count'),
                myOrderContentEl: document.getElementById('my-order-content'), allOrdersListEl: document.getElementById('all-orders-list'),
                grandTotalEl: document.getElementById('grand-total'), userModal: document.getElementById('user-modal'),
                usernameInput: document.getElementById('username-input'), toastEl: document.getElementById('toast'),
                toastMessageEl: document.getElementById('toast-message'), categorySelect: document.getElementById('category-select'),
                dietSelect: document.getElementById('diet-select'), filterCounterContainer: document.getElementById('filter-counter-container'),
                allergenModal: document.getElementById('allergen-modal'), allergenModalContent: document.getElementById('allergen-modal-content'),
            });
            document.body.addEventListener('click', handleEvents);
            document.body.addEventListener('change', handleEvents);
            document.body.addEventListener('input', handleEvents);
            renderFilters();
            renderMenu();
            navigate('menu');
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.currentUser = { uid: user.uid, name: localStorage.getItem('dosemagna-username') };
                if (!state.currentUser.name) dom.userModal.classList.remove('hidden');
                
                onSnapshot(ordersCollectionRef, snapshot => {
                    state.allOrders = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
                    if(state.currentView === 'all-orders') renderAllOrders();
                    renderFavorites();
                });
            } else { signInAnonymously(auth); }
        });
        
        init();
    </script>
</body>
</html>